<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cookie Run Manager</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'CookieRun', 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);
  min-height: 100vh;
  padding: 0;
  overflow-x: hidden;
}

.container {
  max-width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

.header {
  padding: 25px 40px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
}

.logo {
  font-size: 1.8rem;
  font-weight: 800;
  color: #fbbf24;
  text-shadow: 3px 3px 0 #92400e;
}

.tabs {
  display: flex;
  gap: 12px;
}

.tab-btn {
  padding: 10px 28px;
  border: none;
  background: white;
  color: #666;
  font-size: 1rem;
  font-weight: 700;
  border-radius: 15px;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid #fde68a;
  font-family: 'CookieRun';
}

.tab-btn:hover {
  border-color: #fb923c;
  transform: translateY(-2px);
}

.tab-btn.active {
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-color: #fb923c;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
}

.layout {
  display: flex;
  height: calc(100vh - 90px);
  padding: 0 40px 40px;
  gap: 25px;
}

.sidebar-card {
  width: 320px;
  background: white;
  border-radius: 25px;
  box-shadow: 0 8px 24px rgba(146, 64, 14, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 3px solid #fbbf24;
}


.sidebar-header {
  padding: 20px 25px 15px;
  border-bottom: 3px dashed #fde68a;
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  position: relative;
}

.sidebar-edit-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: white;
  border: 2px solid #fb923c;
  color: #fb923c;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.9rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 20;
}

.sidebar-edit-btn:hover {
  transform: rotate(15deg) scale(1.1);
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}

.sidebar-title {
  font-size: 1.2rem;
  font-weight: 800;
  color: #92400e;
  margin-bottom: 15px;
}

.character-photo-box {
  width: 150px;
  height: 150px;
  background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
  background-size: cover;
  background-position: center;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  margin: 0 auto 20px;
  border: 4px solid #fb923c;
  color: white;
  font-weight: 700;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
}

.info-section {
  background: white;
  border-radius: 15px;
  padding: 12px;
  margin-bottom: 10px;
  border: 2px solid #fde68a;
  transition: all 0.3s ease;
}

.sidebar-relations {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 0 25px 25px;
}

.relations-title {
  font-size: 1.2rem;
  font-weight: 800;
  color: #92400e;
  padding: 15px 0 12px;
  flex-shrink: 0;
}

.info-section-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: #92400e;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid #fde68a;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  font-size: 0.85rem;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  color: #a16207;
  font-size: 0.85rem;
  font-weight: 600;
}

.info-value {
  color: #92400e;
  font-weight: 700;
}

.select-message {
  text-align: center;
  color: #f97316;
  font-weight: 700;
  margin: 20px 25px 25px;
  font-size: 0.85rem;
  padding: 10px;
  background: #fffbeb;
  border-radius: 10px;
  border: 2px dashed #fb923c;
  flex-shrink: 0;
}

.character-count {
  padding: 12px 25px;
  font-size: 0.9rem;
  color: #92400e;
  font-weight: 700;
  text-align: center;
  background: #fffbeb;
  border-bottom: 3px solid #fde68a;
}

.character-list {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap; 
  justify-content: flex-start;
  align-content: flex-start;
  gap: 20px;
}

.main-card {
  flex: 1;
  background: white;
  border-radius: 25px;
  box-shadow: 0 8px 24px rgba(146, 64, 14, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 3px solid #fbbf24;
}

.card-header {
  padding: 20px 25px;
  border-bottom: 3px solid #fde68a;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
}

.card-title {
  font-size: 1.2rem;
  font-weight: 800;
  color: #92400e;
}

.card-content {
  flex: 1;
  overflow-y: auto;
  padding: 25px;
}

.create-section {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 25px;
  border: 2px solid #fde68a;
}

.form-grid {
  display: grid;
  gap: 10px;
  margin-bottom: 0;
}

.form-group label {
  display: block;
  font-size: 0.75rem;
  font-weight: 700;
  color: #a16207;
  margin-bottom: 4px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 7px 9px;
  border: 2px solid #fde68a;
  border-radius: 6px;
  font-size: 0.8rem;
  background: white;
  transition: all 0.2s;
  font-weight: 600;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #fb923c;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
}

.btn-add {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
}

.btn-add:hover {
  background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(251, 146, 60, 0.4);
}

.list-section {
  background: white;
  border-radius: 12px;
  padding: 20px;
  min-height: 400px;
  border: 2px solid #fde68a;
}

.empty-message {
  text-align: center;
  color: #a16207;
  padding: 40px;
  font-size: 0.95rem;
  line-height: 1.8;
}

.character-card {
  background: white;
  border: 3px solid #fde68a;
  border-radius: 20px;
  padding: 5px;
  margin-bottom: 12px;
  margin-right: 25px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  width: 420px;
  display: flex;
  overflow: visible;
}

.character-card:hover {
  transform: translateY(-4px) scale(1.02);
}

.char-card-photo {
  width: 160px;
  height: 180px;
  min-width: 110px;
  border-radius: 15px;
  margin: 8px;
  background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  color: white;
  position: relative;
  border: 3px solid #fb923c;
  overflow: hidden;
}

.char-card-photo::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 0%);
  animation: float 6s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(-20px, -20px) rotate(180deg); }
}

.char-card-photo i {
  font-size: 2rem;
  color: white;
  z-index: 1;
}

.char-card-content {
  flex: 1;
  padding: 12px;
  display: flex;
  flex-direction: column;
}

.char-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #fde68a;
}

.char-card-name {
  font-weight: 800;
  color: #92400e;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.char-card-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 5px 12px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 6px rgba(251, 146, 60, 0.3);
}

.grade-ì»¤ë¨¼ {
  background: linear-gradient(135deg, #efac48 0%, #e89830 100%);
  box-shadow: 0 2px 6px rgba(139, 69, 19, 0.3);
}

.grade-ë ˆì–´ {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
}

.grade-ì—í”½ {
  background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
  box-shadow: 0 2px 6px rgba(168, 85, 247, 0.3);
}

.grade-ìŠˆí¼ì—í”½ {
  background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
  box-shadow: 0 2px 6px rgba(236, 72, 153, 0.3);
}

.grade-ë ˆì „ë”ë¦¬ {
  background: linear-gradient(135deg, #79f0b8 0%, #79daf0 25%, #79a3f0 50%, #9179f0 75%, #dc79f0 100%);
  box-shadow: 0 2px 6px rgba(255, 215, 0, 0.5);
  animation: rainbow-glow 3s ease-in-out infinite;
}

.char-card-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.char-card-info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 10px;
  background: #fffbeb;
  border-radius: 10px;
  transition: all 0.2s;
  border: 1px solid #fde68a;
}

.char-card-info-item:hover {
  background: #fef3c7;
  transform: scale(1.05);
}

.char-card-label {
  font-size: 0.8rem;
  color: #a16207;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.char-card-value {
  font-size: 0.9rem;
  color: #92400e;
  font-weight: 700;
}

.char-card-delete-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: white;
  color: #f97316;
  border: 2px solid #fb923c;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(146, 64, 14, 0.2);
  opacity: 0;
  z-index: 10;
}

.character-card:hover .char-card-delete-btn {
  opacity: 1;
}

.char-card-delete-btn:hover {
  background: #f97316;
  color: white;
  transform: scale(1.15) rotate(90deg);
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
}

.page {
  display: none;
}

.page.active {
  display: flex;
}

.character-list::-webkit-scrollbar,
.card-content::-webkit-scrollbar {
  width: 6px;
}

.character-list::-webkit-scrollbar-track,
.card-content::-webkit-scrollbar-track {
  background: transparent;
}

.character-list::-webkit-scrollbar-thumb,
.card-content::-webkit-scrollbar-thumb {
  background: #fde68a;
  border-radius: 10px;
}

.character-list::-webkit-scrollbar-thumb:hover,
.card-content::-webkit-scrollbar-thumb:hover {
  background: #fb923c;
}

.photo-upload {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  background: #fde68a;
  display: inline-block;
  border: 3px solid #fb923c;
}

.photo-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-upload span {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  color: white;
  background: rgba(251, 146, 60, 0.8);
  opacity: 0;
  transition: .2s;
}

.photo-upload:hover span {
  opacity: 1;
}

input[type="color"] {
  width: 100%;
  height: 32px;
  padding: 2px;
  border: 2px solid #fde68a;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

input[type="color"]::-webkit-color-swatch-wrapper {
  padding: 2px;
}

input[type="color"]::-webkit-color-swatch {
  border: none;
  border-radius: 4px;
}

input[type="color"]:focus {
  outline: none;
  border-color: #fb923c;
}

input[type="color"]:hover {
  border-color: #fb923c;
}

.relation-item {
  background: #fffbeb;
  border: 2px solid #fde68a;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.relation-item:hover {
  background: #fef3c7;
  border-color: #fb923c;
  transform: translateX(5px);
}

.relation-name {
  font-weight: 700;
  color: #92400e;
  margin-bottom: 5px;
  font-size: 0.9rem;
}

.relation-value {
  color: #a16207;
  font-size: 0.85rem;
  font-weight: 600;
}

.tag-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  margin-right: 5px;
  box-shadow: 0 2px 6px rgba(251, 146, 60, 0.3);
}

.tag-badge::before {
  content: '#';
  margin-right: 2px;
}

.sidebar-tag-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-radius: 15px;
  font-size: 0.75rem;
  font-weight: 700;
  box-shadow: 0 2px 4px rgba(251, 146, 60, 0.2);
}

.sidebar-tag-badge::before {
  content: '#';
  margin-right: 2px;
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(146, 64, 14, 0.7);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  border-radius: 25px;
  width: 90%;
  max-width: 900px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(146, 64, 14, 0.4);
  border: 4px solid #fbbf24;
  animation: slideUp 0.3s ease;
  position: relative;
}

@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(50px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  padding: 25px 30px;
  border-bottom: 3px solid #fde68a;
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 21px 21px 0 0;
}

.modal-title {
  font-size: 1.4rem;
  font-weight: 800;
  color: #92400e;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close-btn {
  background: white;
  color: #f97316;
  border: 2px solid #fb923c;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(146, 64, 14, 0.2);
}

.modal-close-btn:hover {
  background: #f97316;
  color: white;
  transform: rotate(90deg) scale(1.1);
}

.modal-body {
  padding: 30px;
}

.modal-footer {
  padding: 20px 30px;
  border-top: 3px solid #fde68a;
  background: #fffbeb;
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  border-radius: 0 0 21px 21px;
}

.btn-cancel {
  padding: 12px 30px;
  background: white;
  color: #92400e;
  border: 2px solid #fde68a;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-cancel:hover {
  border-color: #fb923c;
  background: #fffbeb;
  transform: translateY(-2px);
}

.btn-create {
  padding: 12px 30px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
}

.btn-create:hover {
  background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(251, 146, 60, 0.4);
}

.add-character-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border: none;
  border-radius: 15px;
  font-size: 1.05rem;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.add-character-btn:hover {
  background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: #fef3c7;
}

.modal-content::-webkit-scrollbar-thumb {
  background: #fb923c;
  border-radius: 10px;
}

.modal-tab-btn {
  padding: 10px 24px;
  border: none;
  background: white;
  color: #666;
  font-size: 0.9rem;
  font-weight: 700;
  border-radius: 10px 10px 0 0;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid #fde68a;
  border-bottom: none;
}

.modal-tab-btn:hover {
  background: #fffbeb;
  color: #92400e;
}

.modal-tab-btn.active {
  background: white;
  color: #92400e;
  border-color: #fb923c;
  border-bottom: 2px solid white;
  position: relative;
  z-index: 1;
}

.modal-form-page {
  display: none;
}

.modal-form-page.active {
  display: block;
}

.pagination-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 15px 0 10px;
  flex-shrink: 0;
}

.pagination-btn {
  background: white;
  color: #fb923c;
  border: 2px solid #fde68a;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.pagination-btn:hover:not(:disabled) {
  background: #fb923c;
  color: white;
  border-color: #fb923c;
  transform: scale(1.1);
}

.pagination-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.pagination-indicator {
  font-size: 0.85rem;
  color: #92400e;
  font-weight: 700;
  padding: 5px 12px;
  background: #fffbeb;
  border-radius: 12px;
  border: 2px solid #fde68a;
}

.relation-page {
  display: none;
}

.relation-page.active {
  display: block;
}

.sub-page {
  display: none;
}

.sub-page.active {
  display: block;
}

.relations-grid {
  background: white;
  border-radius: 12px;
  padding: 20px;
  min-height: 400px;
  border: 2px solid #fde68a;
}

.filter-btn {
  padding: 8px 16px;
  border: 2px solid #fde68a;
  background: white;
  color: #92400e;
  font-size: 0.85rem;
  font-weight: 700;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-btn:hover {
  border-color: #fb923c;
  background: #fffbeb;
}

.filter-btn.active {
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-color: #fb923c;
  box-shadow: 0 2px 8px rgba(251, 146, 60, 0.3);
}

.relation-char-card {
  background: white;
  border: 2px solid #fde68a;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 2px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  min-height: 80px;
}

.relation-char-photo {
  width: 70px;
  height: 70px;
  border-radius: 10px;
  background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  border: 2px solid #fb923c;
  flex-shrink: 0;
  overflow: hidden;
}

.relation-char-info {
  flex: 1;
}

.relation-char-name {
  font-weight: 700;
  color: #92400e;
  font-size: 0.98rem;
  margin-bottom: 4px;
}

.relation-char-game {
  font-size: 0.75rem;
  color: #a16207;
  font-weight: 600;
}

.relation-char-card:hover {
  transform: translateX(10px) translateY(-3px) scale(1.05);
}

.relationship-card {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border: 2px solid #fde68a;
  border-radius: 15px;
  padding: 10px;
  margin-bottom: 15px;
  transition: all 0.2s;
}

.relationship-card:hover {
  transform: translateY(-2px);
}

.relationship-delete-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: white;
  color: #f97316;
  border: 2px solid #fb923c;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(146, 64, 14, 0.2);
  opacity: 0;
  z-index: 10;
}

.relationship-card:hover .relationship-delete-btn {
  opacity: 1;
}

.relationship-delete-btn:hover {
  background: #f97316;
  color: white;
  transform: scale(1.15) rotate(90deg);
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
}

.relationship-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px dashed #fde68a;
}

.relationship-target-photo {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  background: linear-gradient(135deg, #fde68a 0%, #fbbf24 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  border: 3px solid #fb923c;
  flex-shrink: 0;
  overflow: hidden;
}

.relationship-target-info {
  flex: 1;
}

.relationship-target-name {
  font-size: 1.1rem;
  font-weight: 800;
  color: #92400e;
  margin-bottom: 5px;
}

.relationship-type-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 12px;
  background: white;
  border: 2px solid #fde68a;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
  color: #92400e;
}

.relationship-comment {
  background: white;
  border-radius: 10px;
  padding: 15px;
  color: #92400e;
  font-size: 0.9rem;
  line-height: 1.6;
  font-weight: 600;
  border: 2px solid #fde68a;
}

.relationship-comment::before {
  content: 'ğŸ’¬ ';
  font-size: 1.1rem;
}

.add-relation-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
}

.add-relation-btn:hover {
  background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(251, 146, 60, 0.4);
}

.relation-node {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  border: 3px solid #fb923c;
  position: relative;
  cursor: pointer;
  transition: all 0.3s;
  overflow: hidden;
}

.relation-node:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(251, 146, 60, 0.4);
}

.relation-node-center {
  width: 100px;
  height: 100px;
  font-size: 2.5rem;
  border-width: 4px;
  z-index: 10;
}

.relation-line {
  position: absolute;
  height: 3px;
  background: linear-gradient(90deg, #fb923c, #fde68a);
  transform-origin: left center;
  z-index: 1;
}

.relation-label {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 700;
  color: #92400e;
  border: 2px solid #fde68a;
  white-space: nowrap;
}

.relation-graph {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding: 40px 20px;
}

.relation-nodes-container {
  position: relative;
  width: 100%;
  height: 100%;
}

.settings-editable-area {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 100px;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.settings-editable-area::-webkit-scrollbar {
  display: none;
}

.text-editor-toolbar {
  display: flex;
  gap: 5px;
  padding: 10px;
  background: #fffbeb;
  border: 2px solid #fde68a;
  border-radius: 8px 8px 0 0;
  border-bottom: none;
  flex-wrap: wrap;
}

.editor-btn {
  padding: 8px 12px;
  background: white;
  color: #92400e;
  border: 2px solid #fde68a;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 700;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.editor-btn:hover {
  background: #fef3c7;
  border-color: #fb923c;
  transform: translateY(-1px);
}

.editor-btn.active {
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-color: #fb923c;
}

.editor-textarea {
  width: 100%;
  padding: 15px;
  border: 2px solid #fde68a;
  border-radius: 0 0 8px 8px;
  font-weight: 600;
  min-height: 350px; 
  resize: vertical;
  font-family: inherit;
  font-size: 0.9rem;
  line-height: 1.6;
}

.editor-textarea:focus {
  outline: none;
  border-color: #fb923c;
  box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.1);
}

.settings-editable-area:hover {
  background: #fffbeb;
}

.settings-content {
  color: #92400e;
  font-size: 0.985rem;
  line-height: 1.8;
  white-space: pre-wrap;
  word-wrap: break-word;
  font-weight: 520;
}

.settings-placeholder {
  color: #a16207;
  font-style: italic;
  text-align: center;
  padding: 40px 20px;
}

@font-face {
    font-family: 'CookieRun';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
    font-weight: normal;
    font-display: swap;
}

@font-face {
    font-family: 'CookieRun';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/CookieRunOTF-Bold00.woff') format('woff');
    font-weight: 700;
    font-display: swap;
}

@font-face {
    font-family: 'CookieRun';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/CookieRunOTF-Black00.woff') format('woff');
    font-weight: 900;
    font-display: swap;
}

.format-help {
  position: relative;
  display: inline-block;
  margin-left: 8px;
  cursor: help;
}

.format-help-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
  color: white;
  border-radius: 50%;
  font-size: 0.75rem;
  font-weight: 700;
  box-shadow: 0 2px 6px rgba(251, 146, 60, 0.3);
}

.format-help-tooltip {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  left: 30px;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  border: 2px solid #fde68a;
  border-radius: 12px;
  padding: 15px;
  min-width: 280px;
  box-shadow: 0 8px 24px rgba(146, 64, 14, 0.2);
  z-index: 1000;
  transition: all 0.3s;
  white-space: nowrap;
}

.format-help:hover .format-help-tooltip {
  visibility: visible;
  opacity: 1;
}

.format-help-tooltip::before {
  content: '';
  position: absolute;
  left: -8px;
  top: 50%;
  transform: translateY(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: transparent #fde68a transparent transparent;
}

.format-help-tooltip-title {
  font-size: 0.85rem;
  font-weight: 800;
  color: #92400e;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 2px solid #fde68a;
}

.format-help-item {
  font-size: 0.75rem;
  color: #a16207;
  font-weight: 600;
  margin: 6px 0;
  line-height: 1.5;
}

.format-help-item code {
  background: #fef3c7;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  color: #92400e;
  font-weight: 700;
}


.char-card-game-index {
  position: absolute;
  top: 50%;
  right: -30px;
  transform: translateY(-80%);
  display: flex;
  flex-direction: column;
  gap: 6px;
  z-index: 100;
  pointer-events: auto;
}

.game-index-btn {
  width: 30px;
  height: 40px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid #fde68a;
  background: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  writing-mode: vertical-rl;
  text-orientation: mixed;
  pointer-events: auto;
}

.game-index-btn:hover {
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
}

.game-index-btn.active {
  width: 12px;
  background: linear-gradient(180deg, #fb923c 0%, #f97316 100%);
  border-color: #fb923c;
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
  transform: translateX(-2px) scale(1.05);
}

.game-index-btn.disabled {
  opacity: 0.3;
  cursor: not-allowed;
  pointer-events: none;
}

.game-index-btn[data-game="ovenbreak"] {
  background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
  border-color: #fbbf24;
}

.game-index-btn[data-game="kingdom"] {
  background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
  border-color: #8b5cf6;
}

.game-index-btn[data-game="tower"] {
  background: linear-gradient(90deg, #10b981 0%, #059669 100%);
  border-color: #10b981;
}

.game-index-btn[data-game="ovenbreak"].active {
  background: linear-gradient(90deg, #f59e0b 0%, #ea580c 100%);
  border-color: #f59e0b;
  box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
}

.game-index-btn[data-game="kingdom"].active {
  background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%);
  border-color: #7c3aed;
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
}

.game-index-btn[data-game="tower"].active {
  background: linear-gradient(90deg, #059669 0%, #047857 100%);
  border-color: #059669;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
}

.character-card {
  position: relative;
}


@media (max-width: 768px) {

  .header {
    flex-direction: column;
    padding: 15px 20px;
    gap: 15px;
  }
  
  .logo {
    font-size: 1.4rem;
  }
  
  .tabs {
    width: 100%;
    justify-content: center;
  }
  
  .tab-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .layout {
    flex-direction: column;
    height: auto;
    padding: 20px;
    gap: 20px;
  }
  
  .sidebar-card {
    width: 100%;
  }
  
  .main-card {
    width: 100%;
  }
  
.card-content {
  padding: 0;
  max-height: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
  
.list-section {
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  width: 100%;
}
  
.add-character-btn {
  margin: 15px;
  padding: 12px 24px !important;
  font-size: 0.9rem !important;
  width: auto !important;
  max-width: 280px !important;
}  

  .character-list {
    padding: 15px 10px;
    overflow-x: hidden;
    overflow-y: auto;
    flex-wrap: wrap;
    scroll-snap-type: none;
    gap: 15px;
    justify-content: center;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .character-card {
    width: calc(100% - 20px);
    max-width: 280px;
    min-width: 280px;
    flex-shrink: 0;
    scroll-snap-align: center;
    margin: 0 auto 15px auto;
    flex-direction: column;
    display: flex;
    padding: 10px;
    overflow: hidden;
    box-sizing: border-box;
  }
  
.char-card-content {
    width: 100%;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  
  .char-card-photo {
    width: 220px;
    height: 220px;
    margin: 0 auto 10px auto;
    border-radius: 12px;
  }
  
  .char-card-game-index {
    flex-direction: row;
    top: auto;
    bottom: 10px;
    right: 10px;
    transform: none;
  }
  
  .game-index-btn {
    width: 40px;
    height: 12px;
    writing-mode: horizontal-tb;
  }
  
  .game-index-btn.active {
    height: 12px;
    width: 12px;
    transform: scale(1.2);
  }
  
  .char-card-delete-btn {
    opacity: 1;
  }
  
  .modal-content {
    width: 95%;
    max-height: 90vh;
  }
  
  .modal-body {
    padding: 20px 15px;
  }
  
  .modal-body > div:first-child {
    flex-direction: column;
    align-items: center;
  }
  
  .modal-body .photo-upload {
    width: 120px;
    height: 120px;
    margin-bottom: 15px;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .char-card-info {
    grid-template-columns: 1fr 1fr;
    width: 100%;
  }
  
.char-card-info-item {
    text-align: center;
  }

  #allRelationsPage .sidebar-card {
    width: 100%;
  }
  
  .relation-char-card {
    padding: 15px;
  }
  
  .relation-char-photo {
    width: 60px;
    height: 60px;
  }
  

#allRelationsPage .main-card {
  flex: none !important;
  width: 340px !important;
  min-width: 0 !important; 
}

#allRelationsPage .sidebar-card:last-child {
  width: auto !important;
  flex: 1 !important;
  border-radius: 25px;
  background: white;
  box-shadow: 0 8px 24px rgba(146, 64, 14, 0.15);
  border: 3px solid #fbbf24;
}
  .relation-node {
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
  }
  
  .relation-node-center {
    width: 80px;
    height: 80px;
    font-size: 2rem;
  }
  
  .container {
    height: auto;
    min-height: 100vh;
  }
  
  .character-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .character-card:active {
    transform: scale(0.98);
  }
}

@media (max-width: 400px) {
  .logo {
    font-size: 1.2rem;
  }
  
  .tab-btn {
    padding: 6px 12px;
    font-size: 0.75rem;
  }
  
  .card-title {
    font-size: 1rem;
  }
  
  .char-card-name {
    font-size: 1rem;
  }
  
  .modal-title {
    font-size: 1.1rem;
  }
  
  .character-card {
    width: 90vw;
    min-width: 280px;
  }
}

@keyframes swipeBounce {
  0%, 100% {
    transform: translateX(-50%) translateY(0);
  }
  50% {
    transform: translateX(-50%) translateY(-5px);
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  to {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }
}

.sidebar-action-btn {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  background: white;
  border: 2px solid #fb923c;
  color: #fb923c;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.sidebar-action-btn:hover {
  background: #fffbeb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(251, 146, 60, 0.2);
}

.origin-filter-group {
  display: flex;
  background: white;
  border: 2px solid #fde68a;
  border-radius: 20px;
  overflow: hidden;
}

.origin-btn {
  border: none;
  background: white;
  padding: 6px 14px;
  font-size: 0.8rem;
  font-weight: 700;
  color: #a16207;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'CookieRun';
  border-right: 1px solid #fde68a;
}

.origin-btn:last-child {
  border-right: none;
}

.origin-btn:hover {
  background: #fff7ed;
}

.origin-btn.active {
  background: #fb923c;
  color: white;
}

</style>
</head>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhHY5rckvvfQoI0znLrXEQe4iutvhZzek",
  authDomain: "ckocmanarge3234.firebaseapp.com",
  projectId: "ckocmanarge3234",
  storageBucket: "ckocmanarge3234.firebasestorage.app",
  messagingSenderId: "462191633540",
  appId: "1:462191633540:web:e0341340081cafa0a2ced1"
};
try {
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  window.firebaseDB = db;
  window.firebaseDoc = doc;
  window.firebaseSetDoc = setDoc;
  window.firebaseGetDoc = getDoc;
  window.firebaseOnSnapshot = onSnapshot;
  window.firebaseReady = true;
  
  window.dispatchEvent(new Event('firebaseReady'));
} catch (error) {
  console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  window.firebaseReady = false;
  window.dispatchEvent(new Event('firebaseReady'));
  alert('Firebase ì—°ê²° ì‹¤íŒ¨! ë¡œì»¬ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
}

</script>
<body>

<div id="loginScreen" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
">
  <div style="
    background: white;
    padding: 40px;
    border-radius: 25px;
    box-shadow: 0 20px 60px rgba(146, 64, 14, 0.3);
    border: 4px solid #fbbf24;
    text-align: center;
    max-width: 400px;
  ">
    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸª</div>
    <h2 style="color: #92400e; font-size: 1.5rem; font-weight: 800; margin-bottom: 10px;">
      ì¿ í‚¤ëŸ° ìºë¦­í„° ì •ë¦¬
    </h2>
    <p style="color: #a16207; margin-bottom: 30px; font-weight: 600;">
      ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”
    </p>
    
    <input 
      type="password" 
      id="passwordInput" 
      placeholder="ë¹„ë°€ë²ˆí˜¸"
      style="
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #fde68a;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 15px;
        box-sizing: border-box;
      "
      onkeypress="if(event.key==='Enter') checkPassword()"
    />
    
    <button 
      onclick="checkPassword()"
      style="
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
      "
      onmouseover="this.style.background='linear-gradient(135deg, #f97316 0%, #ea580c 100%)'"
      onmouseout="this.style.background='linear-gradient(135deg, #fb923c 0%, #f97316 100%)'"
    >
      ì…ì¥í•˜ê¸°
    </button>
    
    <div id="errorMessage" style="
      color: #dc2626;
      margin-top: 15px;
      font-weight: 700;
      font-size: 0.9rem;
      display: none;
    ">
      ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="logo">ğŸª ì¿ í‚¤ëŸ° ìºë¦­í„° ì •ë¦¬</div>
<div class="tabs">
  <button class="tab-btn active" onclick="showPage('characters')">ìºë¦­í„° ëª©ë¡</button>
  <button class="tab-btn" onclick="showPage('allRelations')">ì „ì²´ ê´€ê³„ë„</button>
</div>  </div>

<div id="charactersPage" class="page active layout">
  <div class="sidebar-card">
    <div class="sidebar-header">
      <div class="character-photo-box" id="selectedPhoto">
        ğŸª
      </div>
      
      <div class="info-section" id="selectedInfoSection">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">ì´ë¦„</div>
            <div class="info-value">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ë“±ê¸‰</div>
            <div class="info-value">-</div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-relations">
      <div class="relations-title">ìºë¦­í„° ì„¤ì •</div>
      <div id="selectedSettings">
  <div style="text-align:center;color:#a16207;padding:20px;font-weight:700;">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ë©´ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
      </div>
    </div>
  </div>

  <div class="main-card">
<div class="card-header">
  <div class="card-title">ìºë¦­í„° ëª©ë¡</div>
  <div class="character-count" id="characterCount">í˜„ì¬ 0ê°œ</div>
</div>
<div style="padding: 12px 25px; background: #fffbeb; border-bottom: 3px solid #fde68a; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
  
  <div style="display: flex; gap: 10px;">
    <button class="tab-btn active" onclick="filterCharacters('all')">ì „ì²´</button>
    <button class="tab-btn" onclick="filterCharacters('ovenbreak')">ğŸª ì˜¤ë¸ë¸Œë ˆì´í¬</button>
    <button class="tab-btn" onclick="filterCharacters('kingdom')">ğŸ‘‘ í‚¹ë¤</button>
    <button class="tab-btn" onclick="filterCharacters('tower')">ğŸ—¼ ëª¨í—˜ì˜ íƒ‘</button>
  </div>

  <div style="display: flex; align-items: center; gap: 10px;">
    <span style="font-size: 0.8rem; font-weight: 700; color: #a16207; font-family: 'CookieRun';">ğŸ“‚ ë¶„ë¥˜:</span>
    <div class="origin-filter-group">
      <button class="origin-btn active" onclick="setOriginFilter('all')">ì „ì²´</button>
      <button class="origin-btn" onclick="setOriginFilter('oc')">OC</button>
      <button class="origin-btn" onclick="setOriginFilter('official')">ê³µì‹</button>
    </div>
  </div>
  
</div>
    <div class="card-content">
      <button class="add-character-btn" onclick="openModal()">
        <i class="fa-solid fa-plus"></i>
        ìƒˆ ì¿ í‚¤ ì¶”ê°€
      </button>

      <div class="list-section">
        <div id="characterList"></div>
      </div>
    </div>
  </div>
</div>

<div id="allRelationsPage" class="page layout">
  <div class="sidebar-card" style="width: 380px;">
    <div class="card-header" style="border-radius: 22px 22px 0 0;">
      <div class="card-title">ìºë¦­í„° ëª©ë¡</div>
    </div>
    
    <div style="padding: 12px 15px; background: #fffbeb; border-bottom: 2px solid #fde68a; display: flex; gap: 6px; flex-wrap: nowrap;">
      <button class="filter-btn active" onclick="filterRelationsCharacters('all')" data-filter="all" style="padding: 6px 12px; font-size: 0.8rem;">
        ì „ì²´
      </button>
      <button class="filter-btn" onclick="filterRelationsCharacters('ovenbreak')" data-filter="ovenbreak" style="padding: 6px 12px; font-size: 0.8rem;">
        ì˜¤ë¸ë¸Œë ˆì´í¬
      </button>
      <button class="filter-btn" onclick="filterRelationsCharacters('kingdom')" data-filter="kingdom" style="padding: 6px 12px; font-size: 0.8rem;">
        í‚¹ë¤
      </button>
      <button class="filter-btn" onclick="filterRelationsCharacters('tower')" data-filter="tower" style="padding: 6px 12px; font-size: 0.8rem;">
        ëª¨í—˜ì˜ íƒ‘
      </button>
    </div>
    
    <div class="character-count" id="relationsCharacterCount">ì „ì²´ 0ê°œ</div>
    
<div class="character-list" id="relationsCharacterList" style="flex-direction: column; padding: 15px; gap: 8px;">
  <div class="empty-message" style="font-weight:700;">ìºë¦­í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
</div>
  </div>
  
  <div class="main-card" style="flex: 1; min-width: 400px;">
    <div class="card-header">
      <div class="card-title" id="relationsCharacterName">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    </div>
    
    <div class="card-content" id="relationsContent">
      <div class="empty-message" style="padding: 60px 20px; font-weight:700;">
        ì™¼ìª½ì—ì„œ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ë©´<br>ê´€ê³„ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤ ğŸ’•
      </div>
    </div>
  </div>
  
  <div class="sidebar-card" style="width: 380px;">
    <div class="card-header" style="border-radius: 22px 22px 0 0;">
      <div class="card-title">ê´€ê³„ë„</div>
    </div>
    <div class="card-content" id="relationshipVisualization">
      <div class="empty-message" style="padding: 60px 20px; style="font-weight:700;">
        ìºë¦­í„°ë¥¼ ì„ íƒí•˜ë©´<br>ê´€ê³„ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤ ğŸ¨
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalUnified">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        ğŸª ìƒˆ ì¿ í‚¤ ì¶”ê°€
      </div>
      <button class="modal-close-btn" onclick="closeUnifiedModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

<div style="padding: 20px 30px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #fde68a;">
  
  <div id="modalTabs" style="display: flex; gap: 10px;">
    <button type="button" class="modal-tab-btn active" onclick="switchModalTab('ovenbreak')" style="font-family: 'CookieRun';">ì˜¤ë¸ë¸Œë ˆì´í¬</button>
    <button type="button" class="modal-tab-btn" onclick="switchModalTab('kingdom')" style="font-family: 'CookieRun';">í‚¹ë¤</button>
    <button type="button" class="modal-tab-btn" onclick="switchModalTab('tower')" style="font-family: 'CookieRun';">ëª¨í—˜ì˜ íƒ‘</button>
  </div>

  <div style="display: flex; align-items: center; gap: 6px; font-family: 'CookieRun'; white-space: nowrap;">
    <input type="checkbox" id="isOfficialModal" style="width: 15px; height: 15px; cursor: pointer; margin: 0;">
    <label for="isOfficialModal" style="font-size: 0.85rem; font-weight: 800; color: #92400e; cursor: pointer; margin: 0; line-height: 1;">ê³µì‹ ìºë¦­í„°</label>
  </div>

</div>

<div id="formOvenbreak" class="modal-form-page active">
  <div class="modal-body">
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex-shrink: 0;">
        <label class="photo-upload" style="width: 150px; height: 150px; border-radius: 20px;">
          <input type="file" accept="image/*" hidden onchange="previewCreatePhoto(this, 'ovenbreak')">
          <img id="createPhotoPreviewModal" src="" style="display:none">
          <span>ì‚¬ì§„ ì„ íƒ</span>
        </label>
      </div>
      
      <div style="flex: 1;">
        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
          <div class="form-group">
            <label>ì¿ í‚¤ ì´ë¦„</label>
            <input id="charNameModal" placeholder="ì˜ˆ: ìš©ê°í•œì¿ í‚¤" />
          </div>

          <div class="form-group">
            <label>ë“±ê¸‰</label>
            <select id="gradeModal">
              <option selected>ì»¤ë¨¼</option>
              <option>ë ˆì–´</option>
              <option>ì—í”½</option>
              <option>ìŠˆí¼ì—í”½</option>
              <option>ë ˆì „ë”ë¦¬</option>
            </select>
          </div>
          <div class="form-group">
            <label>ì§ê¿ í«</label>
            <input id="petModal" placeholder="ì˜ˆ: ì´ˆì½”ë°©ìš¸" />
          </div>
          <div class="form-group">
            <label>ìƒ‰ìƒ</label>
            <input type="color" id="charColorModal" value="#fb923c" />
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label>ì§ ë³´ë¬¼</label>
          <input id="treasureModal" placeholder="ì˜ˆ: ë°©ì–´ë§‰ ë²„ë¸”ê±´" />
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>ëŠ¥ë ¥</label>
          <input id="abilityModal" placeholder="ì˜ˆ: ìš©ê°í•¨" />
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label>íƒœê·¸ (# ì œì™¸)</label>
          <input id="tagsModal" placeholder="ì˜ˆ: ë¹„í–‰" />
         <div class="form-group" style="margin-top: 15px;">
        </div>
        </div>
      </div>
    </div>
  </div>
   
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeUnifiedModal()">ì·¨ì†Œ</button>
        <button class="btn-create" onclick="addCharacterFromModal('ovenbreak')">ì¶”ê°€</button>
      </div>
    </div>

    <div id="formKingdom" class="modal-form-page">
      <div class="modal-body">
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
          <div style="flex-shrink: 0;">
            <label class="photo-upload" style="width: 150px; height: 150px; border-radius: 20px;">
              <input type="file" accept="image/*" hidden onchange="previewCreatePhoto(this, 'kingdom')">
              <img id="createPhotoPreviewKingdom" src="" style="display:none">
              <span>ì‚¬ì§„ ì„ íƒ</span>
            </label>
          </div>
          
          <div style="flex: 1;">
            <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
              <div class="form-group">
                <label>ì¿ í‚¤ ì´ë¦„</label>
                <input id="charNameKingdom" placeholder="ì˜ˆ: ìš©ê°í•œì¿ í‚¤" />
              </div>
              <div class="form-group">
                <label>ë“±ê¸‰</label>
                <select id="gradeKingdom">
                  <option selected>ì»¤ë¨¼</option>
                  <option>ë ˆì–´</option>
                  <option>ì—í”½</option>
                  <option>ìŠˆí¼ì—í”½</option>
                  <option>ë ˆì „ë”ë¦¬</option>
                </select>
              </div>
              <div class="form-group">
                <label>íƒ€ì…</label>
                <select id="typeKingdom">
                  <option>ëŒê²©í˜•</option>
                  <option>ë§ˆë²•í˜•</option>
                  <option>ì‚¬ê²©í˜•</option>
                  <option>í­ë°œí˜•</option>
                  <option>ì¹¨íˆ¬í˜•</option>
                  <option>ì§€ì›í˜•</option>
                  <option>íšŒë³µí˜•</option>
                  <option>ë°©ì–´í˜•</option>
                </select>
              </div>
              <div class="form-group">
                <label>ìƒ‰ìƒ</label>
                <input type="color" id="charColorKingdom" value="#fb923c" />
              </div>
            </div>
            
<div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
  <div class="form-group">
    <label>í¬ì§€ì…˜</label>
    <select id="positionKingdom">
      <option>ì „ë°©</option>
      <option>ì¤‘ì•™</option>
      <option>í›„ë°©</option>
    </select>
  </div>
  <div class="form-group">
    <label>ì†ì„±</label>
    <select id="elementKingdom">
      <option>ë¶ˆ</option>
      <option>ë¬¼</option>
      <option>ë…</option>
      <option>ë¹›</option>
      <option>ë•…</option>
      <option>ì–¼ìŒ</option>
      <option>ì „ê¸°</option>
      <option>ì–´ë‘ </option>
      <option>ë°”ëŒ</option>
      <option>ê°•ì² </option>
      <option>í’€</option>
    </select>
  </div>
  <div class="form-group">
    <label>ìŠ¤í‚¬ëª…</label>
    <input id="skillNameKingdom" placeholder="ìŠ¤í‚¬ ì´ë¦„" />
  </div>
</div>

<div class="form-group" style="margin-top: 15px;">
  <label>íŠ¹ì„±</label>
  <input id="traitKingdom" placeholder="ì˜ˆ: ë””ë²„í”„ ë©´ì—­" />
</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeUnifiedModal()">ì·¨ì†Œ</button>
        <button class="btn-create" onclick="addCharacterFromModal('kingdom')">ì¶”ê°€</button>
      </div>
    </div>

    <div id="formTower" class="modal-form-page">
      <div class="modal-body">
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
          <div style="flex-shrink: 0;">
            <label class="photo-upload" style="width: 150px; height: 150px; border-radius: 20px;">
              <input type="file" accept="image/*" hidden onchange="previewCreatePhoto(this, 'tower')">
              <img id="createPhotoPreviewTower" src="" style="display:none">
              <span>ì‚¬ì§„ ì„ íƒ</span>
            </label>
          </div>
          
          <div style="flex: 1;">
            <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
              <div class="form-group">
                <label>ì¿ í‚¤ ì´ë¦„</label>
                <input id="charNameTower" placeholder="ì˜ˆ: ìš©ê°í•œì¿ í‚¤" />
              </div>
              <div class="form-group">
                <label>ë“±ê¸‰</label>
                <select id="gradeTower">
                  <option selected>ì»¤ë¨¼</option>
                  <option>ë ˆì–´</option>
                  <option>ì—í”½</option>
                  <option>ìŠˆí¼ì—í”½</option>
                  <option>ë ˆì „ë”ë¦¬</option>
                </select>
              </div>
              <div class="form-group">
                <label>ì—­í• </label>
                <select id="roleTower">
                  <option>ìŠ¤íŠ¸ë¼ì´ì»¤</option>
                  <option>ë°ë¯¸ì§€ ë”œëŸ¬</option>
                  <option>ì„œí¬í„°</option>
                </select>
              </div>
              <div class="form-group">
                <label>ìƒ‰ìƒ</label>
                <input type="color" id="charColorTower" value="#fb923c" />
              </div>
            </div>
            
            <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div class="form-group">
                <label>íƒ€ì…</label>
                <select id="typeTower">
                  <option>íƒ€ê²©í˜•</option>
                  <option>ë² ê¸°í˜•</option>
                  <option>ë§ˆë²•í˜•</option>
                  <option>ì‚¬ê²©í˜•</option>
                  <option>ì§€ì›í˜•</option>
                </select>
              </div>
              <div class="form-group">
                <label>ì†ì„±</label>
                <select id="elementTower">
                  <option>ë¬¼</option>
                  <option>ë¶ˆ</option>
                  <option>ë°”ëŒ</option>
                  <option>ëŒ€ì§€</option>
                  <option>ë¹›</option>
                  <option>ì–´ë‘ </option>
                </select>
              </div>
              <div class="form-group">
                <label>ìŠ¤í‚¬ëª…</label>
                <input id="skillNameTower" placeholder="ìŠ¤í‚¬ ì´ë¦„" />
              </div>
              <div class="form-group">
                <label>ì „ìš© ì•„í‹°íŒ©íŠ¸</label>
                <input id="artifactTower" placeholder="ì˜ˆ: ìš©ê°í•œ ê²€" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeUnifiedModal()">ì·¨ì†Œ</button>
        <button class="btn-create" onclick="addCharacterFromModal('tower')">ì¶”ê°€</button>
      </div>
    </div>
  </div>
</div>

</div>
  </div>
</div>

<div class="modal-overlay" id="modalRelation">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <div class="modal-title">
        ğŸ’• ê´€ê³„ ì¶”ê°€í•˜ê¸°
      </div>
      <button class="modal-close-btn" onclick="closeRelationModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group" style="margin-bottom: 20px;">
        <label>ê´€ê³„ë¥¼ ë§ºì„ ìºë¦­í„°</label>
        <select id="relationTargetChar" style="width: 100%; padding: 10px; border: 2px solid #fde68a; border-radius: 8px; font-weight: 600;">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="form-group" style="margin-bottom: 20px;">
        <label>ê´€ê³„ ìœ í˜•</label>
        <select id="relationType" style="width: 100%; padding: 10px; border: 2px solid #fde68a; border-radius: 8px; font-weight: 600;">
          <option value="ê°€ì¡±">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±</option>
          <option value="ë™ê²½">âœ¨ ë™ê²½</option>
          <option value="í˜¸ê°">ğŸ’• í˜¸ê°</option>
          <option value="ì‹ ë¢°">ğŸ¤ ì‹ ë¢°</option>
          <option value="ë¼ì´ë²Œ">âš”ï¸ ë¼ì´ë²Œ</option>
          <option value="ê²½ê³„">âš ï¸ ê²½ê³„</option>
        </select>
      </div>

      <div class="form-group">
        <label>í•œë§ˆë””</label>
        <textarea id="relationComment" placeholder="ì´ ìºë¦­í„°ì— ëŒ€í•œ ìƒê°ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; padding: 10px; border: 2px solid #fde68a; border-radius: 8px; font-weight: 600; min-height: 100px; resize: vertical; font-family: inherit;"></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeRelationModal()">ì·¨ì†Œ</button>
      <button class="btn-create" onclick="addRelation()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalEditSettings">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <div class="modal-title">
        âš™ï¸ <span id="editSettingsCharName">ìºë¦­í„°</span> ì„¤ì • í¸ì§‘
      </div>
      <button class="modal-close-btn" onclick="closeEditSettingsModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body" id="editSettingsBody">
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeEditSettingsModal()">ì·¨ì†Œ</button>
      <button class="btn-create" onclick="saveSettings()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>

function debugLog(message, isError) {
  const timestamp = new Date().toLocaleTimeString('ko-KR');
  if (isError) {
    console.error(`[${timestamp}] ${message}`);
  } else {
    console.log(`[${timestamp}] ${message}`);
  }
}

const SHARED_PASSWORD = "noncookie5369";

window.checkPassword = async function() {
  const input = document.getElementById('passwordInput').value;
  const errorMsg = document.getElementById('errorMessage');
  
  if (input === SHARED_PASSWORD) {

    sessionStorage.setItem('authenticated', 'true');
    
    debugLog('ğŸ” ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ', false);
    
    if (!window.firebaseReady) {
      debugLog('â³ Firebase ì¤€ë¹„ ëŒ€ê¸° ì¤‘...', false);
      
      let waitCount = 0;
      const waitInterval = setInterval(() => {
        waitCount++;
        
        if (window.firebaseReady) {
          clearInterval(waitInterval);
          debugLog('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ!', false);
          startApp();
        } else if (waitCount >= 20) { 
          clearInterval(waitInterval);
          debugLog('âŒ Firebase íƒ€ì„ì•„ì›ƒ, ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš©', true);
          startApp();
        } else {
          debugLog('â³ ëŒ€ê¸° ì¤‘... (' + (waitCount * 0.5) + 'ì´ˆ)', false);
        }
      }, 500);
    } else {
      debugLog('âœ… Firebase ì´ë¯¸ ì¤€ë¹„ë¨', false);
      startApp();
    }
    
    async function startApp() {
      try {
        document.getElementById('loginScreen').style.display = 'none';
        errorMsg.style.display = 'none';
        
        debugLog('ğŸ“‚ ë°ì´í„° ë¡œë“œ ì‹œì‘...', false);
        
        await loadFromLocalStorage();
        
        debugLog('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ' + characters.length + 'ê°œ', false);
        
        filterCharacters('all');
        
        debugLog('ğŸ¨ í™”ë©´ ë Œë”ë§ ì™„ë£Œ', false);
        
        if (window.firebaseReady) {
          setupRealtimeSync();
          debugLog('ğŸ”¥ ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘', false);
        } else {
          debugLog('âš ï¸ Firebase ë¯¸ì¤€ë¹„, ë™ê¸°í™” ê±´ë„ˆëœ€', true);
        }
        
      } catch (error) {
        debugLog('âŒ ì•± ì‹œì‘ ì˜¤ë¥˜: ' + error.message, true);
        alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
  } else {
    errorMsg.style.display = 'block';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
    debugLog('âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜', true);
  }
}

window.addEventListener('DOMContentLoaded', async function() {
  const isAuthenticated = sessionStorage.getItem('authenticated');
  
  if (isAuthenticated === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    
    await loadFromLocalStorage();
    filterCharacters('all');
  }
});


let characters = [];
let selectedChar = null;
let currentFilter = 'all';

let tempCharData = {
  ovenbreak: {},
  kingdom: {},
  tower: {}
};

function getBrightness(color) {
  const hex = color.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);
  return (r * 0.299 + g * 0.587 + b * 0.114);
}

function isLightColor(color, threshold = 180) {
  return getBrightness(color) > threshold;
}

function darkenColor(color, amount = 0.6) {
  const hex = color.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);
  
  const newR = Math.round(r * amount);
  const newG = Math.round(g * amount);
  const newB = Math.round(b * amount);
  
  const toHex = (num) => {
    const hex = num.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  };
  
  return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
}

async function saveToLocalStorage() {
  try {
    localStorage.setItem('cookierun_characters', JSON.stringify(characters));
    
    debugLog('ğŸ’¾ ë¡œì»¬ ì €ì¥ ì™„ë£Œ: ' + characters.length + 'ê°œ', false);
    
if (window.firebaseDB && window.firebaseDoc && window.firebaseSetDoc) {
  const CHUNK_SIZE = characters.length > 100 ? 1 : (characters.length > 50 ? 2 : 3);
  const chunks = [];
      
      for (let i = 0; i < characters.length; i += CHUNK_SIZE) {
        chunks.push(characters.slice(i, i + CHUNK_SIZE));
      }
      
      const metaDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', 'metadata');
      await window.firebaseSetDoc(metaDocRef, {
        totalCharacters: characters.length,
        totalChunks: chunks.length,
        lastUpdated: new Date().toISOString()
      });
      
      for (let i = 0; i < chunks.length; i++) {
        const chunkDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', `chunk_${i}`);
        await window.firebaseSetDoc(chunkDocRef, {
          characters: chunks[i],
          chunkIndex: i,
          lastUpdated: new Date().toISOString()
        });
      }
      
      try {
        const oldDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', 'shared_data');
        await window.firebaseSetDoc(oldDocRef, { deprecated: true, message: 'ìƒˆë¡œìš´ ì²­í¬ ë°©ì‹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë¨' });
      } catch (e) {
        // ë¬´ì‹œ
      }
      
      debugLog('âœ… Firebase ì €ì¥ ì™„ë£Œ! (' + characters.length + 'ê°œ, ' + chunks.length + 'ê°œ ì²­í¬)', false);
      console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ! (' + characters.length + 'ê°œ, ' + chunks.length + 'ê°œ ì²­í¬)');
    } else {
      debugLog('âš ï¸ Firebase ì‚¬ìš© ë¶ˆê°€, ë¡œì»¬ë§Œ ì €ì¥', true);
      console.log('âš ï¸ Firebase ì‚¬ìš© ë¶ˆê°€, ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë§Œ ì €ì¥');
    }
  } catch (e) {
    debugLog('âŒ ì €ì¥ ì˜¤ë¥˜: ' + e.message, true);
    console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    throw e;
  }
}

function compressImage(file, maxWidth = 300, quality = 0.7) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;

        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        resolve(canvas.toDataURL('image/jpeg', quality));
      };
    };
  });
}

function getElementEmoji(element) {
  const emojiMap = {
    'ë¶ˆ': 'ğŸ”¥', 'ë¬¼': 'ğŸ’§', 'ë…': 'â˜ ï¸', 'ë¹›': 'âœ¨', 'ë•…': 'ğŸŒ',
    'ì–¼ìŒ': 'â„ï¸', 'ì „ê¸°': 'âš¡', 'ì–´ë‘ ': 'ğŸŒ‘', 'ë°”ëŒ': 'ğŸ’¨',
    'ê°•ì² ': 'âš™ï¸', 'í’€': 'ğŸŒ¿', 'ëŒ€ì§€': 'ğŸŒ'
  };
  return emojiMap[element] || 'â­';
}

function getRelationIcon(type) {
  const icons = {
    'ê°€ì¡±': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', 'ë™ê²½': 'âœ¨', 'í˜¸ê°': 'ğŸ’•',
    'ì‹ ë¢°': 'ğŸ¤', 'ë¼ì´ë²Œ': 'âš”ï¸', 'ê²½ê³„': 'âš ï¸'
  };
  return icons[type] || 'ğŸ’­';
}

function formatText(text) {
  if (!text) return '';
  
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 1000;">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/__(.*?)__/g, '<u>$1</u>')
    .replace(/~~(.*?)~~/g, '<s>$1</s>')
    .replace(/^# (.+)$/gm, '<div style="font-size: 1.2rem; font-weight: 800; margin: 10px 0; color: #92400e;">$1</div>')
    .replace(/^- (.+)$/gm, '<div style="margin-left: 15px;">â€¢ $1</div>')
    .replace(/^> (.+)$/gm, '<div style="border-left: 3px solid #fb923c; padding-left: 10px; margin: 5px 0; color: #a16207; font-style: italic;">$1</div>');
}

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.header .tab-btn').forEach(b => b.classList.remove('active'));
  
  if (page === 'characters') {
    document.getElementById('charactersPage').classList.add('active');
    document.querySelectorAll('.header .tab-btn')[0].classList.add('active');
    filterCharacters(currentFilter);
  } else if (page === 'allRelations') {
    document.getElementById('allRelationsPage').classList.add('active');
    document.querySelectorAll('.header .tab-btn')[1].classList.add('active');
    renderRelationsPage(currentRelationsFilter || 'all');
  }
}

function filterCharacters(filter) {
  currentFilter = filter;
  
  const filterBtns = document.querySelectorAll('#charactersPage .tab-btn');
  filterBtns.forEach(btn => btn.classList.remove('active'));
  
  if (filter === 'all') filterBtns[0].classList.add('active');
  else if (filter === 'ovenbreak') filterBtns[1].classList.add('active');
  else if (filter === 'kingdom') filterBtns[2].classList.add('active');
  else if (filter === 'tower') filterBtns[3].classList.add('active');
  
let filteredCharacters = characters.filter(char => {

    let gameMatch = false;
    if (filter === 'all') gameMatch = true;
    else if (filter === 'ovenbreak') gameMatch = char.ovenbreak;
    else if (filter === 'kingdom') gameMatch = char.kingdom;
    else if (filter === 'tower') gameMatch = char.tower;
    

    let originMatch = true;
    const isOfficial = char.isOfficial === true; // ë°ì´í„°ì— ì €ì¥ëœ ê°’ í™•ì¸
    
    if (currentOriginFilter === 'oc') {
      originMatch = !isOfficial;
    } else if (currentOriginFilter === 'official') {
      originMatch = isOfficial;
    }
    
    return gameMatch && originMatch;
  });
  
  document.getElementById('characterCount').textContent = `í˜„ì¬ ${filteredCharacters.length}ê°œ`;
  
  const list = document.getElementById('characterList');
  
  if (filteredCharacters.length === 0) {
  list.innerHTML = '<div class="empty-message" style="font-weight:700;">ì•„ì§ ë“±ë¡ëœ ì¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ìƒˆë¡œìš´ ì¿ í‚¤ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸª</div>';
  return;
}
  
  list.innerHTML = filteredCharacters.map(char => renderCharacterCard(char, filter)).join('');

  if (!sessionStorage.getItem('swipeIndicatorShown')) {
    setTimeout(() => {
      addSwipeIndicator();
      sessionStorage.setItem('swipeIndicatorShown', 'true');
    }, 500);
  }
}

let currentRelationsFilter = 'all';
let selectedRelationChar = null;

function filterRelationsCharacters(filter) {
  currentRelationsFilter = filter;
  
  document.querySelectorAll('#allRelationsPage .filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === filter) {
      btn.classList.add('active');
    }
  });
  
  renderRelationsPage(filter);
}

function renderRelationsPage(filter) {

  let filteredCharacters = characters;
  
  if (filter !== 'all') {
    filteredCharacters = characters.filter(char => {
      if (filter === 'ovenbreak') return char.ovenbreak;
      if (filter === 'kingdom') return char.kingdom;
      if (filter === 'tower') return char.tower;
      return false;
    });
  }
  
  const list = document.getElementById('relationsCharacterList');
  const count = document.getElementById('relationsCharacterCount');
  
  count.textContent = `ì „ì²´ ${filteredCharacters.length}ê°œ`;
  
  if (filteredCharacters.length === 0) {
    list.innerHTML = '<div class="empty-message">ìºë¦­í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
    document.getElementById('relationsContent').innerHTML = '<div class="empty-message" style="padding: 60px 20px;">ì™¼ìª½ì—ì„œ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ë©´<br>ê´€ê³„ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤ ğŸ’•</div>';
    return;
  }
  
  list.innerHTML = filteredCharacters.map(char => renderRelationCharCard(char)).join('');
}

let cardDisplayGame = {}; // { charId: 'ovenbreak' | 'kingdom' | 'tower' }

function renderCharacterCard(char, currentFilter) {
 
  const games = [];
  if (char.ovenbreak) games.push({ key: 'ovenbreak', icon: 'ğŸª', name: 'ì˜¤ë¸ë¸Œë ˆì´í¬' });
  if (char.kingdom) games.push({ key: 'kingdom', icon: 'ğŸ‘‘', name: 'í‚¹ë¤' });
  if (char.tower) games.push({ key: 'tower', icon: 'ğŸ—¼', name: 'ëª¨í—˜ì˜ íƒ‘' });
  
  if (!cardDisplayGame[char.id]) {
    cardDisplayGame[char.id] = games[0].key;
  }
  
  const displayGame = cardDisplayGame[char.id];
  const gameData = char[displayGame];
  
const gameIndexButtons = `
  <div class="char-card-game-index">
    ${games.map(g => `
      <div class="game-index-btn ${displayGame === g.key ? 'active' : ''}" 
           onclick="switchCardGame(event, ${char.id}, '${g.key}')"
           title="${g.name}"
           data-game="${g.key}">
      </div>
    `).join('')}
    ${games.length < 3 ? Array(3 - games.length).fill(0).map(() => `
      <div class="game-index-btn disabled">
      </div>
    `).join('') : ''}
  </div>
`;
  
  const color = gameData.color || '#fb923c';
  
  return `
    <div class="character-card" onclick="selectCharacter(${char.id}, '${displayGame}')" 
      onmouseover="this.style.boxShadow='0 8px 24px ${color}50';" 
      onmouseout="this.style.boxShadow='0 4px 12px ${color}30';"
      style="background: linear-gradient(135deg, ${isLightColor(color) ? darkenColor(color, 0.3) : color + '20'} 0%, ${isLightColor(color) ? darkenColor(color, 0.2) : color + '10'} 100%); 
             border-color: ${color}; box-shadow: 0 4px 12px ${color}30;">
      
      ${gameIndexButtons}
      
      <div class="char-card-photo" style="background: ${color}; border-color: ${color}; position: relative;">
        ${gameData.photo ? `<img src="${gameData.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:15px;">` : 'ğŸª'}
        ${(displayGame === 'kingdom' || displayGame === 'tower') && gameData.element ? `
          <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(255, 255, 255, 0.95); 
                      border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; 
                      justify-content: center; font-size: 1.3rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
                      border: 2px solid white;">
            ${getElementEmoji(gameData.element)}
          </div>
        ` : ''}
      </div>
      
      <div class="char-card-content">
        <div class="char-card-header" style="border-bottom-color: ${color};">
          <div class="char-card-name" style="color: ${color}; filter: brightness(0.7);">${char.name}</div>
          <div class="char-card-badge grade-${gameData.grade}">${gameData.grade}</div>
        </div>
        
        ${renderCardInfo(displayGame, gameData, color)}
      </div>
      
      <button class="char-card-delete-btn" onclick="deleteCharacter(event, ${char.id})">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  `;
}

function renderCardInfo(game, data, color) {
  if (game === 'ovenbreak') {
    return `
      <div class="char-card-info">
        ${data.pet ? `
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ì§ê¿ í«</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.pet}</div>
        </div>
        ` : ''}
        ${data.treasure ? `
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ì§ ë³´ë¬¼</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.treasure}</div>
        </div>
        ` : ''}
        ${data.ability ? `
        <div class="char-card-info-item" style="grid-column: 1 / -1; background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ëŠ¥ë ¥</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.ability}</div>
        </div>
        ` : ''}
      </div>
    `;
  } else if (game === 'kingdom') {
    return `
      <div class="char-card-info">
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">íƒ€ì…</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.type}</div>
        </div>
        ${data.position ? `
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">í¬ì§€ì…˜</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.position}</div>
        </div>
        ` : ''}
        ${data.skillName ? `
        <div class="char-card-info-item" style="grid-column: 1 / -1; background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ìŠ¤í‚¬</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.skillName}</div>
        </div>
        ` : ''}
      </div>
    `;
  } else if (game === 'tower') {
    return `
      <div class="char-card-info">
        ${data.role ? `
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ì—­í• </div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.role}</div>
        </div>
        ` : ''}
        <div class="char-card-info-item" style="background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">íƒ€ì…</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.type}</div>
        </div>
        ${data.skillName ? `
        <div class="char-card-info-item" style="grid-column: 1 / -1; background: ${isLightColor(color) ? darkenColor(color, 0.15) : 'white'}; border-color: ${color};">
          <div class="char-card-label" style="color: ${color}; filter: brightness(0.7);">ìŠ¤í‚¬</div>
          <div class="char-card-value" style="color: ${color}; filter: brightness(1.0);">${data.skillName}</div>
        </div>
        ` : ''}
      </div>
    `;
  }
}

function switchCardGame(event, charId, game) {
  event.stopPropagation();
  cardDisplayGame[charId] = game;
  filterCharacters(currentFilter);
}


function renderRelationCharCard(char) {

  const games = [];
  if (char.ovenbreak) games.push({ key: 'ovenbreak', data: char.ovenbreak, name: 'ì˜¤ë¸ë¸Œë ˆì´í¬' });
  if (char.kingdom) games.push({ key: 'kingdom', data: char.kingdom, name: 'í‚¹ë¤' });
  if (char.tower) games.push({ key: 'tower', data: char.tower, name: 'ëª¨í—˜ì˜ íƒ‘' });
  
  const firstGame = games[0];
  const color = firstGame.data.color || '#fb923c';
  
return `
    <div class="relation-char-card" 
         onclick="selectRelationCharacter(${char.id}, event)" 
         onmouseover="this.style.borderColor='${color}'; this.style.boxShadow='0 8px 24px ${color}50';" 
         onmouseout="this.style.borderColor='${color}'; this.style.boxShadow='0 4px 12px ${color}30';"
         style="background: linear-gradient(135deg, ${isLightColor(color) ? darkenColor(color, 0.3) : color + '20'} 0%, ${isLightColor(color) ? darkenColor(color, 0.2) : color + '10'} 100%); 
                border-color: ${color}; box-shadow: 0 4px 12px ${color}30;">
      <div class="relation-char-photo" style="background: ${color}; border-color: ${color};">
        ${firstGame.data.photo ? `<img src="${firstGame.data.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">` : 'ğŸª'}
      </div>
      <div class="relation-char-info">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <div class="relation-char-name" style="color: ${color};">${char.name}</div>
          <div class="char-card-badge grade-${firstGame.data.grade}" style="font-size: 0.7rem; padding: 3px 8px;">${firstGame.data.grade}</div>
        </div>
        <div class="relation-char-game">${games.map(g => g.name).join(' / ')}</div>
      </div>
    </div>
  `;
}

function selectCharacter(id, game) {
  const char = characters.find(c => c.id === id);
  if (!char) return;
  
  selectedChar = { ...char, displayGame: game };
  const gameData = char[game];
  const color = gameData.color || '#fb923c';
  
  // 1. ê¸°ì¡´ ì‚¬ì´ë“œë°” í—¤ë” ê°€ì ¸ì˜¤ê¸°
  const sidebarHeader = document.querySelector('#charactersPage .sidebar-header');
  
  // 2. [ì‹ ê·œ] ê¸°ì¡´ì— ìˆë˜ í¸ì§‘ ë²„íŠ¼ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  const existingBtn = sidebarHeader.querySelector('.sidebar-edit-btn');
  if (existingBtn) existingBtn.remove();
  
  // 3. ì‚¬ì§„ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
  const photoBox = document.getElementById('selectedPhoto');
  if (gameData.photo) {
    photoBox.innerHTML = `<img src="${gameData.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:20px;">`;
  } else {
    photoBox.innerHTML = 'ğŸª';
  }
  photoBox.style.background = gameData.color;
  photoBox.style.borderColor = gameData.color;
  photoBox.style.boxShadow = `0 4px 12px ${gameData.color}50`;
  
  // 4. í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  if (sidebarHeader) {
    sidebarHeader.style.background = isLightColor(color) 
      ? `linear-gradient(135deg, ${darkenColor(color, 0.2)} 0%, ${darkenColor(color, 0.15)} 100%)`
      : `${color}20`;
    sidebarHeader.style.borderBottomColor = color;

    // 5. [ì‹ ê·œ] ë™ê·¸ë€ í¸ì§‘ ë²„íŠ¼ ìƒì„± ë° ì¶”ê°€
    const editBtn = document.createElement('button');
    editBtn.className = 'sidebar-edit-btn';
    editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
    editBtn.title = 'ì •ë³´ ë° ì‚¬ì§„ ìˆ˜ì •';
    
    // ìƒ‰ìƒ ì ìš©
    editBtn.style.borderColor = color;
    editBtn.style.color = color;
    
    // í˜¸ë²„ íš¨ê³¼ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸
    editBtn.onmouseenter = function() {
      this.style.background = color;
      this.style.color = 'white';
    };
    editBtn.onmouseleave = function() {
      this.style.background = 'white';
      this.style.color = color;
    };
    
    // í´ë¦­ ì´ë²¤íŠ¸
    editBtn.onclick = function(e) {
      e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
      openEditCharacterModal(selectedChar.id, game);
    };
    
    sidebarHeader.appendChild(editBtn);
  }
  
  const sidebarCard = document.querySelector('#charactersPage .sidebar-card');
  if (sidebarCard) {
    sidebarCard.style.borderColor = color;
  }
  
  const infoSection = document.getElementById('selectedInfoSection');
  infoSection.innerHTML = renderSidebarInfo(game, gameData);
  infoSection.style.borderColor = color;
  
  if (!isLightColor(color, 180)) {
    infoSection.style.background = 'white';
  } else {
    infoSection.style.background = isLightColor(color) 
      ? darkenColor(color, 0.15)
      : `${color}25`;
  }
  
  updateSettingsArea(char, gameData);
}

function renderSidebarInfo(game, data) {
  const color = data.color || '#fb923c';

let infoContent = '';

  if (game === 'ovenbreak') {
    infoContent = `
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì´ë¦„</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.name || selectedChar.name}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ë“±ê¸‰</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.grade}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì§ê¿ í«</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.pet || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì§ ë³´ë¬¼</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.treasure || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ëŠ¥ë ¥</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.ability || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">íƒœê·¸</div>
          <div class="info-value">${data.tags ? `<span class="sidebar-tag-badge" style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); box-shadow: 0 2px 6px ${color}50;">${data.tags}</span>` : '-'}</div>
        </div>
      </div>
    `;
  } else if (game === 'kingdom') {
    infoContent = `
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì´ë¦„</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.name || selectedChar.name}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ë“±ê¸‰</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.grade}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">íƒ€ì…</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.type}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">í¬ì§€ì…˜</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.position}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì†ì„±</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.element || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">íŠ¹ì„±</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.trait || '-'}</div>
        </div>
      </div>
    `;
  } else if (game === 'tower') {
    infoContent = `
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì´ë¦„</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.name || selectedChar.name}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ë“±ê¸‰</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.grade}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì—­í• </div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.role || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">íƒ€ì…</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.type}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì†ì„±</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.element || '-'}</div>
        </div>
        <div class="info-item">
          <div class="info-label" style="color: ${color}; filter: brightness(0.7);">ì•„í‹°íŒ©íŠ¸</div>
          <div class="info-value" style="color: ${color}; filter: brightness(1.0);">${data.artifact || '-'}</div>
        </div>
      </div>
    `;
  }

  return infoContent;
}

function updateSettingsArea(char, gameData) {
  const settingsArea = document.getElementById('selectedSettings');
  const color = gameData.color || '#fb923c';
  
  settingsArea.innerHTML = char.characterSettings 
    ? `<div class="settings-content">${formatText(char.characterSettings)}</div>`
    : `<div class="settings-placeholder">ë”ë¸”í´ë¦­í•˜ì—¬ ìºë¦­í„° ì„¤ì •ì„ ì‘ì„±í•˜ì„¸ìš”...</div>`;
  
  settingsArea.className = 'settings-editable-area';
  settingsArea.ondblclick = () => openEditSettingsModal(char.id);
  settingsArea.style.background = `${color}08`;
  settingsArea.style.borderColor = color;
  
  settingsArea.onmouseenter = function() {
    this.style.background = `${color}15`;
  };
  settingsArea.onmouseleave = function() {
    this.style.background = `${color}08`;
  };
  
  const settingsContent = settingsArea.querySelector('.settings-content');
  if (settingsContent) {
    settingsContent.style.color = color;
    settingsContent.style.filter = 'brightness(0.6)';
  }
  
  const settingsPlaceholder = settingsArea.querySelector('.settings-placeholder');
  if (settingsPlaceholder) {
    settingsPlaceholder.style.color = color;
    settingsPlaceholder.style.filter = 'brightness(0.7)';
  }
  
  const relationsTitle = document.querySelector('#charactersPage .relations-title');
  if (relationsTitle) {
    relationsTitle.style.color = color;
    relationsTitle.style.filter = 'brightness(0.7)';
  }
}

function selectRelationCharacter(id, event) {
  const char = characters.find(c => c.id === id);
  if (!char) return;
  
  const games = [];
  if (char.ovenbreak) games.push({ key: 'ovenbreak', data: char.ovenbreak });
  if (char.kingdom) games.push({ key: 'kingdom', data: char.kingdom });
  if (char.tower) games.push({ key: 'tower', data: char.tower });
  
  const firstGame = games[0];
  selectedRelationChar = { ...char, displayGame: firstGame.key };
  
  document.querySelectorAll('.relation-char-card').forEach(card => card.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  
  document.getElementById('relationsCharacterName').textContent = `${char.name}ì˜ ê´€ê³„`;
  
  renderRelationships(char, firstGame.data);
  renderRelationshipVisualization(char, firstGame.data);
}

let currentModalGame = 'ovenbreak';

function openModal() {
  isEditMode = false;
  editingCharacterId = null;
  currentModalGame = 'ovenbreak';
  
  document.querySelectorAll('.btn-create').forEach(btn => btn.textContent = 'ì¶”ê°€');
  document.querySelector('.modal-title').innerHTML = 'ğŸª ìƒˆ ì¿ í‚¤ ì¶”ê°€';
  
  switchModalTab('ovenbreak');
  document.getElementById('modalUnified').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function openModal() {
  isEditMode = false;
  editingCharacterId = null;
  currentModalGame = 'ovenbreak';
  
  tempCharData = {
    ovenbreak: null,
    kingdom: null,
    tower: null
  };
  
  document.querySelectorAll('.btn-create').forEach(btn => btn.textContent = 'ì¶”ê°€');
  document.querySelector('.modal-title').innerHTML = 'ğŸª ìƒˆ ì¿ í‚¤ ì¶”ê°€';
  
  // ì˜¤ë¸ë¸Œë ˆì´í¬ í¼ ì´ˆê¸°í™”
  document.getElementById('charNameModal').value = '';
  document.getElementById('gradeModal').value = 'ì»¤ë¨¼';
  document.getElementById('petModal').value = '';
  document.getElementById('treasureModal').value = '';
  document.getElementById('abilityModal').value = '';
  document.getElementById('tagsModal').value = '';
  document.getElementById('charColorModal').value = '#fb923c';
  document.getElementById('isOfficialModal').checked = false;
  
  const preview = document.getElementById('createPhotoPreviewModal');
  preview.style.display = 'none';
  preview.src = '';
  preview.parentElement.querySelector('span').style.display = 'flex';
  
  // í‚¹ë¤ í¼ ì´ˆê¸°í™”
  document.getElementById('charNameKingdom').value = '';
  document.getElementById('gradeKingdom').value = 'ì»¤ë¨¼';
  document.getElementById('typeKingdom').value = 'ëŒê²©í˜•';
  document.getElementById('positionKingdom').value = 'ì „ë°©';
  document.getElementById('elementKingdom').value = 'ë¶ˆ';
  document.getElementById('skillNameKingdom').value = '';
  document.getElementById('traitKingdom').value = '';
  document.getElementById('charColorKingdom').value = '#fb923c'; // ì´ ì¤„ ì¶”ê°€!
  
  const previewKingdom = document.getElementById('createPhotoPreviewKingdom');
  previewKingdom.style.display = 'none';
  previewKingdom.src = '';
  previewKingdom.parentElement.querySelector('span').style.display = 'flex';
  
  // íƒ€ì›Œ í¼ ì´ˆê¸°í™”
  document.getElementById('charNameTower').value = '';
  document.getElementById('gradeTower').value = 'ì»¤ë¨¼';
  document.getElementById('roleTower').value = 'ìŠ¤íŠ¸ë¼ì´ì»¤';
  document.getElementById('typeTower').value = 'íƒ€ê²©í˜•';
  document.getElementById('elementTower').value = 'ë¬¼';
  document.getElementById('skillNameTower').value = '';
  document.getElementById('artifactTower').value = '';
  document.getElementById('charColorTower').value = '#fb923c'; // ì´ ì¤„ ì¶”ê°€!
  
  const previewTower = document.getElementById('createPhotoPreviewTower');
  previewTower.style.display = 'none';
  previewTower.src = '';
  previewTower.parentElement.querySelector('span').style.display = 'flex';
  
  switchModalTab('ovenbreak');
  document.getElementById('modalUnified').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function switchModalTab(game) {
  saveTempData(currentModalGame);
  
  currentModalGame = game;
  
  document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.modal-form-page').forEach(page => page.classList.remove('active'));
  
  const tabButtons = document.querySelectorAll('.modal-tab-btn');
  if (game === 'ovenbreak') {
    tabButtons[0].classList.add('active');
    document.getElementById('formOvenbreak').classList.add('active');
    restoreTempData('ovenbreak');
  } else if (game === 'kingdom') {
    tabButtons[1].classList.add('active');
    document.getElementById('formKingdom').classList.add('active');
    restoreTempData('kingdom');
  } else if (game === 'tower') {
    tabButtons[2].classList.add('active');
    document.getElementById('formTower').classList.add('active');
    restoreTempData('tower');
  }
}

function saveTempData(game) {
  if (game === 'ovenbreak') {
    const preview = document.getElementById('createPhotoPreviewModal');
    tempCharData.ovenbreak = {
      name: document.getElementById('charNameModal').value.trim(),
      grade: document.getElementById('gradeModal').value,
      pet: document.getElementById('petModal').value.trim(),
      treasure: document.getElementById('treasureModal').value.trim(),
      ability: document.getElementById('abilityModal').value.trim(),
      tags: document.getElementById('tagsModal').value.trim(),
      color: document.getElementById('charColorModal').value,
      photo: (preview && preview.style.display !== 'none') ? preview.src : ''
    };
  } else if (game === 'kingdom') {
    const preview = document.getElementById('createPhotoPreviewKingdom');
    tempCharData.kingdom = {
      name: document.getElementById('charNameKingdom').value.trim(),
      grade: document.getElementById('gradeKingdom').value,
      type: document.getElementById('typeKingdom').value,
      position: document.getElementById('positionKingdom').value,
      element: document.getElementById('elementKingdom').value,
      skillName: document.getElementById('skillNameKingdom').value.trim(),
      trait: document.getElementById('traitKingdom').value.trim(),
      color: document.getElementById('charColorKingdom').value,
      photo: (preview && preview.style.display !== 'none') ? preview.src : ''
    };
  } else if (game === 'tower') {
    const preview = document.getElementById('createPhotoPreviewTower');
    tempCharData.tower = {
      name: document.getElementById('charNameTower').value.trim(),
      grade: document.getElementById('gradeTower').value,
      role: document.getElementById('roleTower').value,
      type: document.getElementById('typeTower').value,
      element: document.getElementById('elementTower').value,
      skillName: document.getElementById('skillNameTower').value.trim(),
      artifact: document.getElementById('artifactTower').value.trim(),
      color: document.getElementById('charColorTower').value,
      photo: (preview && preview.style.display !== 'none') ? preview.src : ''
    };
  }
}

function restoreTempData(game) {
  if (game === 'ovenbreak' && tempCharData.ovenbreak && tempCharData.ovenbreak.name) {
    document.getElementById('charNameModal').value = tempCharData.ovenbreak.name;
    document.getElementById('gradeModal').value = tempCharData.ovenbreak.grade || 'ì»¤ë¨¼';
    document.getElementById('petModal').value = tempCharData.ovenbreak.pet || '';
    document.getElementById('treasureModal').value = tempCharData.ovenbreak.treasure || '';
    document.getElementById('abilityModal').value = tempCharData.ovenbreak.ability || '';
    document.getElementById('tagsModal').value = tempCharData.ovenbreak.tags || '';
    document.getElementById('charColorModal').value = tempCharData.ovenbreak.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewModal');
    if (tempCharData.ovenbreak.photo) {
      preview.src = tempCharData.ovenbreak.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    }
  } else if (game === 'kingdom' && tempCharData.kingdom && tempCharData.kingdom.name) {
    document.getElementById('charNameKingdom').value = tempCharData.kingdom.name;
    document.getElementById('gradeKingdom').value = tempCharData.kingdom.grade || 'ì»¤ë¨¼';
    document.getElementById('typeKingdom').value = tempCharData.kingdom.type || 'ëŒê²©í˜•';
    document.getElementById('positionKingdom').value = tempCharData.kingdom.position || 'ì „ë°©';
    document.getElementById('elementKingdom').value = tempCharData.kingdom.element || 'ë¶ˆ';
    document.getElementById('skillNameKingdom').value = tempCharData.kingdom.skillName || '';
    document.getElementById('traitKingdom').value = tempCharData.kingdom.trait || '';
    document.getElementById('charColorKingdom').value = tempCharData.kingdom.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewKingdom');
    if (tempCharData.kingdom.photo) {
      preview.src = tempCharData.kingdom.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    }
  } else if (game === 'tower' && tempCharData.tower && tempCharData.tower.name) {
    document.getElementById('charNameTower').value = tempCharData.tower.name;
    document.getElementById('gradeTower').value = tempCharData.tower.grade || 'ì»¤ë¨¼';
    document.getElementById('roleTower').value = tempCharData.tower.role || 'ìŠ¤íŠ¸ë¼ì´ì»¤';
    document.getElementById('typeTower').value = tempCharData.tower.type || 'íƒ€ê²©í˜•';
    document.getElementById('elementTower').value = tempCharData.tower.element || 'ë¬¼';
    document.getElementById('skillNameTower').value = tempCharData.tower.skillName || '';
    document.getElementById('artifactTower').value = tempCharData.tower.artifact || '';
    document.getElementById('charColorTower').value = tempCharData.tower.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewTower');
    if (tempCharData.tower.photo) {
      preview.src = tempCharData.tower.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    }
  }
}

async function previewCreatePhoto(input, game) {
  const suffix = game === 'ovenbreak' ? 'Modal' : game.charAt(0).toUpperCase() + game.slice(1);
  const preview = document.getElementById('createPhotoPreview' + suffix);
  
  if (input.files && input.files[0]) {
    try {
      const compressedDataUrl = await compressImage(input.files[0]);
      
      preview.src = compressedDataUrl;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
      
    } catch (e) {
      console.error("ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨", e);
      alert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }
}

function clearForm(game) {
  if (game === 'ovenbreak') {
    document.getElementById('charNameModal').value = '';
    document.getElementById('gradeModal').value = 'ì»¤ë¨¼';
    document.getElementById('petModal').value = '';
    document.getElementById('treasureModal').value = '';
    document.getElementById('abilityModal').value = '';
    document.getElementById('tagsModal').value = '';
    document.getElementById('charColorModal').value = '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewModal');
    const fileInput = preview.parentElement.querySelector('input[type="file"]');
    if (fileInput) fileInput.value = '';
    preview.src = '';
    preview.style.display = 'none';
    preview.parentElement.querySelector('span').style.display = 'flex';
  } else if (game === 'kingdom') {
    document.getElementById('charNameKingdom').value = '';
    document.getElementById('gradeKingdom').value = 'ì»¤ë¨¼';
    document.getElementById('typeKingdom').value = 'ëŒê²©í˜•';
    document.getElementById('positionKingdom').value = 'ì „ë°©';
    document.getElementById('elementKingdom').value = 'ë¶ˆ';
    document.getElementById('skillNameKingdom').value = '';
    document.getElementById('traitKingdom').value = '';
    document.getElementById('charColorKingdom').value = '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewKingdom');
    const fileInput = preview.parentElement.querySelector('input[type="file"]');
    if (fileInput) fileInput.value = '';
    preview.src = '';
    preview.style.display = 'none';
    preview.parentElement.querySelector('span').style.display = 'flex';
  } else if (game === 'tower') {
    document.getElementById('charNameTower').value = '';
    document.getElementById('gradeTower').value = 'ì»¤ë¨¼';
    document.getElementById('roleTower').value = 'ìŠ¤íŠ¸ë¼ì´ì»¤';
    document.getElementById('typeTower').value = 'íƒ€ê²©í˜•';
    document.getElementById('elementTower').value = 'ë¬¼';
    document.getElementById('skillNameTower').value = '';
    document.getElementById('artifactTower').value = '';
    document.getElementById('charColorTower').value = '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewTower');
    const fileInput = preview.parentElement.querySelector('input[type="file"]');
    if (fileInput) fileInput.value = '';
    preview.src = '';
    preview.style.display = 'none';
    preview.parentElement.querySelector('span').style.display = 'flex';
  }
}

async function deleteCharacter(event, id) {
  event.stopPropagation();
  
  if (!confirm('ì •ë§ ì´ ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  characters = characters.filter(c => c.id !== id);
  
  characters.forEach(char => {
    if (char.relations) {
      char.relations = char.relations.filter(rel => rel.targetId !== id);
    }
  });

  await saveToLocalStorage();
  filterCharacters(currentFilter);
  alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

async function saveToLocalStorage() {
  try {
    // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ (ë°±ì—…ìš©)
    localStorage.setItem('cookierun_characters', JSON.stringify(characters));
    debugLog('ğŸ’¾ ë¡œì»¬ ì €ì¥ ì™„ë£Œ: ' + characters.length + 'ê°œ', false);
    
    // 2. Firebase ì €ì¥
    if (window.firebaseDB && window.firebaseDoc && window.firebaseSetDoc) {
      
      // ë©”íƒ€ë°ì´í„° ì €ì¥
      const metaDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', 'metadata');
      await window.firebaseSetDoc(metaDocRef, {
        totalCharacters: characters.length,
        lastUpdated: new Date().toISOString(),
        saveFormat: 'individual_doc' // ì €ì¥ ë°©ì‹ êµ¬ë¶„
      });
      
      // ê°œë³„ ë¬¸ì„œë¡œ ë¶„ì‚° ì €ì¥
      const savePromises = characters.map(char => {
        const charDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun_data', `char_${char.id}`);
        return window.firebaseSetDoc(charDocRef, char);
      });

      await Promise.all(savePromises);
      
      debugLog('âœ… Firebase ì €ì¥ ì™„ë£Œ! (ê°œë³„ ë¬¸ì„œ ë°©ì‹)', false);
      console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ!');
    } else {
      debugLog('âš ï¸ Firebase ì‚¬ìš© ë¶ˆê°€, ë¡œì»¬ë§Œ ì €ì¥', true);
    }
  } catch (e) {
    debugLog('âŒ ì €ì¥ ì˜¤ë¥˜: ' + e.message, true);
    console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    throw e;
  }
}

async function loadFromLocalStorage() {
  try {
    debugLog('ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', false);
    
    if (window.firebaseDB && window.firebaseDoc && window.firebaseGetDoc) {
      const metaDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', 'metadata');
      const metaSnap = await window.firebaseGetDoc(metaDocRef);
      
      if (metaSnap.exists()) {
        const metadata = metaSnap.data();
        
        if (metadata.saveFormat === 'individual_doc') {
            const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");
            const querySnapshot = await getDocs(collection(window.firebaseDB, "cookierun_data"));
            
            characters = [];
            querySnapshot.forEach((doc) => {
                characters.push(doc.data());
            });
            console.log('âœ… Firebase ë°ì´í„° ë¡œë“œ ì™„ë£Œ (ê°œë³„ ë¬¸ì„œ): ' + characters.length + 'ê°œ');

        } else {
            const totalChunks = metadata.totalChunks || 0;
            characters = [];
            for (let i = 0; i < totalChunks; i++) {
                const chunkDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', `chunk_${i}`);
                const chunkSnap = await window.firebaseGetDoc(chunkDocRef);
                if (chunkSnap.exists()) {
                    const chunkData = chunkSnap.data();
                    characters = characters.concat(chunkData.characters || []);
                }
            }
            console.log('âœ… Firebase ë°ì´í„° ë¡œë“œ ì™„ë£Œ (ì²­í¬): ' + characters.length + 'ê°œ');
        }
      }
    }
    
    if (characters.length === 0) {
      const stored = localStorage.getItem('cookierun_characters');
      if (stored) {
        characters = JSON.parse(stored);
        debugLog('ğŸ“¦ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ: ' + characters.length + 'ê°œ', false);
      }
    }

  } catch (e) {
    debugLog('âŒ ë¡œë“œ ì˜¤ë¥˜: ' + e.message, true);
    console.error('âŒ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', e);
    const stored = localStorage.getItem('cookierun_characters');
    if (stored) characters = JSON.parse(stored);
  }
}

function renderRelationships(char, gameData) {
  const content = document.getElementById('relationsContent');
  const color = gameData.color || '#fb923c';
  
  if (!char.relations || char.relations.length === 0) {
    content.innerHTML = `
      <button class="add-relation-btn" onclick="openRelationModal(${char.id})">
        <i class="fa-solid fa-plus"></i>
        ê´€ê³„ ì¶”ê°€í•˜ê¸°
      </button>
      <div class="empty-message" style="padding: 40px 20px;">
        ì•„ì§ ì„¤ì •ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤<br>
        ê´€ê³„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸ’•
      </div>
    `;
    return;
  }
  
const relationshipCards = char.relations.map((rel, relIndex) => {  // relIndex ì¶”ê°€
  const targetColor = rel.targetColor || '#fb923c';
  
  return `
    <div class="relationship-card" 
      onmouseover="this.style.boxShadow='0 8px 24px ${targetColor}50';" 
      onmouseout="this.style.boxShadow='0 4px 12px ${targetColor}30';"
      style="position: relative; background: linear-gradient(135deg, ${isLightColor(targetColor) ? darkenColor(targetColor, 0.3) : targetColor + '20'} 0%, ${isLightColor(targetColor) ? darkenColor(targetColor, 0.2) : targetColor + '10'} 100%); 
             border-color: ${targetColor}; box-shadow: 0 4px 12px ${targetColor}30;">
      
      <button class="relationship-delete-btn" onclick="deleteRelation(event, ${char.id}, ${relIndex})">
        <i class="fa-solid fa-xmark"></i>
      </button>
      
      <div class="relationship-header" style="border-bottom-color: ${targetColor};">
        <div class="relationship-target-photo" style="background: ${targetColor}; border-color: ${targetColor};">
          ${rel.targetPhoto ? `<img src="${rel.targetPhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">` : 'ğŸª'}
        </div>
        <div class="relationship-target-info">
          <div class="relationship-target-name" style="color: ${targetColor}; filter: brightness(0.7);">${rel.targetName}</div>
          <div class="relationship-type-badge" style="border-color: ${targetColor}; color: ${targetColor}; background: white;">
            ${getRelationIcon(rel.relationType)} ${rel.relationType}
          </div>
        </div>
      </div>
      <div class="relationship-comment" style="border-color: ${targetColor}; background: ${targetColor}white; color: ${targetColor};">
        ${rel.comment}
      </div>
    </div>
  `;
}).join('');  

  content.innerHTML = `
    <button class="add-relation-btn" onclick="openRelationModal(${char.id})">
      <i class="fa-solid fa-plus"></i>
      ê´€ê³„ ì¶”ê°€í•˜ê¸°
    </button>
    ${relationshipCards}
  `;
}

function renderRelationshipVisualization(char, gameData) {
  const container = document.getElementById('relationshipVisualization');
  const mainColor = gameData.color || '#fb923c'; 
  
  if (!char.relations || char.relations.length === 0) {
    container.innerHTML = '<div class="empty-message" style="padding: 60px 20px; font-weight:700; color: #666; display:flex; align-items:center; justify-content:center; height:100%;">ì•„ì§ ì„¤ì •ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤<br>ê´€ê³„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸ’•</div>';
    return;
  }
  
  const centerNode = `
    <div class="relation-node relation-node-center" style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 140px; 
      height: 140px;
      background: ${mainColor};
      border: 6px solid #fff;
      border-radius: 50%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      z-index: 20; 
      overflow: hidden;
      transition: all 0.3s;
    "
    onmouseover="this.style.transform='translate(-50%, -50%) scale(1.05)'"
    onmouseout="this.style.transform='translate(-50%, -50%) scale(1)'"
    >
      ${gameData.photo ? `<img src="${gameData.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:50px;">ğŸª</div>'}
    </div>
  `;
  
  const angleStep = (2 * Math.PI) / char.relations.length;
  const radiusPx = 300; 
  
  const relationNodes = char.relations.map((rel, index) => {
    const angle = angleStep * index - Math.PI / 2;
    
    const xOffset = radiusPx * Math.cos(angle);
    const yOffset = radiusPx * Math.sin(angle);
    
    const labelX = (radiusPx / 2) * Math.cos(angle);
    const labelY = (radiusPx / 2) * Math.sin(angle);
    
    const lineAngle = angle * 180 / Math.PI;
    const targetColor = rel.targetColor || '#fb923c';
    const icon = getRelationIcon ? getRelationIcon(rel.relationType) : 'â¤ï¸';
    
    return `
      <div class="relation-line" style="
        position: absolute;
        top: 50%;
        left: 50%;
        width: ${radiusPx}px;
        height: 6px;
        background: ${targetColor};
        transform-origin: left center;
        transform: rotate(${lineAngle}deg);
        z-index: 1;
        opacity: 0.7;
        box-shadow: 0 0 8px ${targetColor}40;
        pointer-events: none;
      "></div>

      <div class="relation-label" style="
        position: absolute;
        top: calc(50% + ${labelY}px);
        left: calc(50% + ${labelX}px);
        transform: translate(-50%, -50%);
        background: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.95rem;
        font-weight: 800;
        color: ${targetColor};
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 3px solid ${targetColor};
        z-index: 15;
      ">
          ${icon} ${rel.relationType}
      </div>

      <div class="relation-node-wrapper" style="
        position: absolute;
        top: calc(50% + ${yOffset}px);
        left: calc(50% + ${xOffset}px);
        transform: translate(-50%, -50%);
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s;
      "
      onmouseover="this.style.transform='translate(-50%, -50%) scale(1.1)'; this.style.zIndex='30';"
      onmouseout="this.style.transform='translate(-50%, -50%) scale(1)'; this.style.zIndex='10';"
      onclick="selectCharacter(${rel.targetId}, 'ovenbreak')" 
      >
        <div style="
          width: 110px;
          height: 110px;
          background: #fff;
          border: 5px solid ${targetColor};
          border-radius: 50%;
          overflow: hidden;
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        ">
          ${rel.targetPhoto ? `<img src="${rel.targetPhoto}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:35px;">ğŸª</div>'}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = `
    <div class="relation-graph" style="
        position: relative; 
        width: 100%; 
        height: 100%; 
        min-height: 800px;
        overflow: visible;
        background: radial-gradient(circle, #fffbeb 0%, transparent 85%); 
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    ">
      <div class="relation-nodes-container" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
        ${centerNode}
        ${relationNodes}
      </div>
    </div>
  `;
}

let currentRelationCharId = null;

function openRelationModal(charId) {
  currentRelationCharId = charId;
  
  const otherCharacters = characters.filter(c => c.id !== charId);
  
  if (otherCharacters.length === 0) {
    alert('ê´€ê³„ë¥¼ ë§ºì„ ë‹¤ë¥¸ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìºë¦­í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!');
    return;
  }
  
  const select = document.getElementById('relationTargetChar');
  select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + 
    otherCharacters.map(char => {
      const games = [];
      if (char.ovenbreak) games.push('ì˜¤ë¸ë¸Œë ˆì´í¬');
      if (char.kingdom) games.push('í‚¹ë¤');
      if (char.tower) games.push('ëª¨í—˜ì˜ íƒ‘');
      const gameNames = games.join(', ');
      
      return `<option value="${char.id}">${char.name} (${gameNames})</option>`;
    }).join('');
  
  document.getElementById('relationType').value = 'ê°€ì¡±';
  document.getElementById('relationComment').value = '';
  
  document.getElementById('modalRelation').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeRelationModal() {
  document.getElementById('modalRelation').classList.remove('active');
  document.body.style.overflow = '';
  currentRelationCharId = null;
}

async function addRelation() {
  const targetId = parseInt(document.getElementById('relationTargetChar').value);
  const relationType = document.getElementById('relationType').value;
  const comment = document.getElementById('relationComment').value.trim();
  
  if (!targetId) {
    alert('ê´€ê³„ë¥¼ ë§ºì„ ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  if (!comment) {
    alert('í•œë§ˆë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
    return;
  }
  
  // ë°°ì—´ì—ì„œ ì¸ë±ìŠ¤ ì°¾ê¸°
  const currentCharIndex = characters.findIndex(c => c.id === currentRelationCharId);
  const targetChar = characters.find(c => c.id === targetId);
  
  if (currentCharIndex === -1 || !targetChar) {
    alert('ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }
  
  let targetColor = '#fb923c';
  let targetPhoto = '';
  
  if (targetChar.ovenbreak) {
    targetColor = targetChar.ovenbreak.color;
    targetPhoto = targetChar.ovenbreak.photo;
  } else if (targetChar.kingdom) {
    targetColor = targetChar.kingdom.color;
    targetPhoto = targetChar.kingdom.photo;
  } else if (targetChar.tower) {
    targetColor = targetChar.tower.color;
    targetPhoto = targetChar.tower.photo;
  }
  
  // ì¸ë±ìŠ¤ë¡œ ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ìˆ˜ì •
  if (!characters[currentCharIndex].relations) {
    characters[currentCharIndex].relations = [];
  }
  
  characters[currentCharIndex].relations.push({
    targetId: targetChar.id,
    targetName: targetChar.name,
    targetColor: targetColor,
    targetPhoto: targetPhoto,
    relationType: relationType,
    comment: comment
  });
  
  // ì €ì¥ ì „ì— ë¡œê·¸ ì¶œë ¥
  console.log('ğŸ’¾ ê´€ê³„ ì €ì¥ ì‹œë„:', characters[currentCharIndex].name, 'â†’', targetChar.name);
  
  try {
    await saveToLocalStorage();
    console.log('âœ… ê´€ê³„ ì €ì¥ ì„±ê³µ!');
  } catch (error) {
    console.error('âŒ ê´€ê³„ ì €ì¥ ì‹¤íŒ¨:', error);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    return;
  }

if (selectedRelationChar && selectedRelationChar.id === currentRelationCharId) {
    const currentChar = characters.find(c => c.id === currentRelationCharId);
    if (currentChar) {
      const displayGame = selectedRelationChar.displayGame;
      const gameData = currentChar[displayGame];
      
      renderRelationships(currentChar, gameData);
      renderRelationshipVisualization(currentChar, gameData);
    }
}
  
  closeRelationModal();
  
  alert('ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
}

document.addEventListener('click', function(e) {
  if (e.target.id === 'modalRelation' && e.target.classList.contains('modal-overlay')) {
    closeRelationModal();
  }
});

let currentEditCharId = null;

function openEditSettingsModal(charId) {
  currentEditCharId = charId;
  
  const char = characters.find(c => c.id === charId);
  if (!char) return;
  
  document.getElementById('editSettingsCharName').textContent = char.name;
  
  const formHTML = `
    <div class="form-group">
      <label style="display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; color: #a16207; margin-bottom: 10px;">
        ìºë¦­í„° ì„¤ì •
        <div class="format-help">
          <div class="format-help-icon">?</div>
          <div class="format-help-tooltip">
            <div class="format-help-tooltip-title">ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì„œì‹</div>
            <div class="format-help-item"><code>**êµµê²Œ**</code> - êµµì€ ê¸€ì”¨</div>
            <div class="format-help-item"><code>*ê¸°ìš¸ì„*</code> - ê¸°ìš¸ì„ ê¸€ì”¨</div>
            <div class="format-help-item"><code>__ë°‘ì¤„__</code> - ë°‘ì¤„</div>
            <div class="format-help-item"><code>~~ì·¨ì†Œì„ ~~</code> - ì·¨ì†Œì„ </div>
            <div class="format-help-item"><code># ì œëª©</code> - í° ì œëª©</div>
            <div class="format-help-item"><code>- ëª©ë¡</code> - ëª©ë¡ í•­ëª©</div>
            <div class="format-help-item"><code>> ì¸ìš©</code> - ì¸ìš©ë¬¸</div>
          </div>
        </div>
      </label>
      
      <div class="text-editor-toolbar">
        <button type="button" class="editor-btn" onclick="insertFormatting('**', '**')" title="êµµê²Œ">
          <i class="fa-solid fa-bold"></i> êµµê²Œ
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('*', '*')" title="ê¸°ìš¸ì„">
          <i class="fa-solid fa-italic"></i> ê¸°ìš¸ì„
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('__', '__')" title="ë°‘ì¤„">
          <i class="fa-solid fa-underline"></i> ë°‘ì¤„
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('~~', '~~')" title="ì·¨ì†Œì„ ">
          <i class="fa-solid fa-strikethrough"></i> ì·¨ì†Œì„ 
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('# ', '')" title="ì œëª©">
          <i class="fa-solid fa-heading"></i> ì œëª©
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('- ', '')" title="ëª©ë¡">
          <i class="fa-solid fa-list"></i> ëª©ë¡
        </button>
        <button type="button" class="editor-btn" onclick="insertFormatting('> ', '')" title="ì¸ìš©">
          <i class="fa-solid fa-quote-left"></i> ì¸ìš©
        </button>
      </div>
      
      <textarea id="editCharacterSettings" class="editor-textarea" placeholder="ìºë¦­í„°ì˜ ì„¤ì •, ë°°ê²½ ìŠ¤í† ë¦¬ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”...">${char.characterSettings || ''}</textarea>
    </div>
  `;
  
  document.getElementById('editSettingsBody').innerHTML = formHTML;
  document.getElementById('modalEditSettings').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeEditSettingsModal() {
  document.getElementById('modalEditSettings').classList.remove('active');
  document.body.style.overflow = '';
  currentEditCharId = null;
}

async function saveSettings() {
  const char = characters.find(c => c.id === currentEditCharId);
  if (!char) return;
  
  char.characterSettings = document.getElementById('editCharacterSettings').value;
  
  await saveToLocalStorage();
  
  if (selectedChar && selectedChar.id === currentEditCharId) {
    const gameData = char[selectedChar.displayGame];
    updateSettingsArea(char, gameData);
  }
  
  closeEditSettingsModal();
  
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾');
}

function insertFormatting(prefix, suffix) {
  const textarea = document.getElementById('editCharacterSettings');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  const beforeText = textarea.value.substring(0, start);
  const afterText = textarea.value.substring(end);
  
  if (selectedText) {
    textarea.value = beforeText + prefix + selectedText + suffix + afterText;
    textarea.selectionStart = start + prefix.length;
    textarea.selectionEnd = end + prefix.length;
  } else {
    textarea.value = beforeText + prefix + suffix + afterText;
    textarea.selectionStart = textarea.selectionEnd = start + prefix.length;
  }
  
  textarea.focus();
}

document.addEventListener('click', function(e) {
  if (e.target.id === 'modalEditSettings' && e.target.classList.contains('modal-overlay')) {
    closeEditSettingsModal();
  }
});

async function deleteRelation(event, charId, relationIndex) {
  event.stopPropagation();
  
  const charIndex = characters.findIndex(c => c.id === charId);
  if (charIndex === -1) return;
  
  characters[charIndex].relations.splice(relationIndex, 1);
  
  await saveToLocalStorage();
  
  if (selectedRelationChar && selectedRelationChar.id === charId) {
    const char = characters[charIndex];
    const gameData = char[selectedRelationChar.displayGame];
    
    renderRelationships(char, gameData);
    renderRelationshipVisualization(char, gameData);
  }
}

function addSwipeIndicator() {
  if (window.innerWidth > 768) return;
  
  const characterList = document.getElementById('characterList');
  if (!characterList) return;
  
  const existingIndicator = document.querySelector('.swipe-indicator');
  if (existingIndicator) {
    existingIndicator.remove();
  }
  
  const cards = characterList.querySelectorAll('.character-card');
  if (cards.length < 2) return;
  
  const indicator = document.createElement('div');
  indicator.className = 'swipe-indicator';
  indicator.innerHTML = `
    <div style="
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(251, 146, 60, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: swipeBounce 2s ease-in-out infinite;
    ">
      <i class="fa-solid fa-hand-point-left"></i>
      ì¢Œìš°ë¡œ ìŠ¤ì™€ì´í”„
      <i class="fa-solid fa-hand-point-right"></i>
    </div>
  `;
  
  document.body.appendChild(indicator);
  
  setTimeout(() => {
    indicator.style.animation = 'fadeOut 0.5s ease';
    setTimeout(() => indicator.remove(), 500);
  }, 3000);
  
  characterList.addEventListener('scroll', function removeOnScroll() {
    indicator.remove();
    characterList.removeEventListener('scroll', removeOnScroll);
  }, { once: true });
}

window.addEventListener('beforeunload', () => {
  if (window.firebaseUnsubscribe) {
    window.firebaseUnsubscribe();
    console.log('ğŸ‘‹ Firebase ë¦¬ìŠ¤ë„ˆ í•´ì œ');
  }
});

function setupRealtimeSync() {
  if (!window.firebaseReady || !window.firebaseDB || !window.firebaseDoc || !window.firebaseOnSnapshot) {
    console.log('â³ Firebase ì¤€ë¹„ ì¤‘... 3ì´ˆ í›„ ì¬ì‹œë„');
    debugLog('â³ Firebase ì¤€ë¹„ ì¤‘... 3ì´ˆ í›„ ì¬ì‹œë„', false);
    setTimeout(setupRealtimeSync, 3000);
    return;
  }
  
  try {
    // metadata ë¬¸ì„œë¥¼ ê°ì‹œ
    const metaDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', 'metadata');
    
    const unsubscribe = window.firebaseOnSnapshot(metaDocRef, 
      async (doc) => {
        try {
          if (doc.exists()) {
            const metadata = doc.data();
            const totalChunks = metadata.totalChunks || 0;
            
            // ëª¨ë“  ì²­í¬ ë¡œë“œ
            let newCharacters = [];
            for (let i = 0; i < totalChunks; i++) {
              const chunkDocRef = window.firebaseDoc(window.firebaseDB, 'cookierun', `chunk_${i}`);
              const chunkSnap = await window.firebaseGetDoc(chunkDocRef);
              
              if (chunkSnap.exists()) {
                const chunkData = chunkSnap.data();
                newCharacters = newCharacters.concat(chunkData.characters || []);
              }
            }
            
            debugLog('ğŸ”¥ Firebase ë°ì´í„° ìˆ˜ì‹ : ' + newCharacters.length + 'ê°œ', false);
            
            const currentData = JSON.stringify(characters);
            const newData = JSON.stringify(newCharacters);
            
            if (currentData !== newData) {
              debugLog('ğŸ”„ ë°ì´í„° ë³€ê²½ ê°ì§€, ì—…ë°ì´íŠ¸ ì¤‘...', false);
              
              console.log('ğŸ”¥ ìƒˆ ë°ì´í„° ìˆ˜ì‹ :', newCharacters.length + 'ê°œ');
              characters = newCharacters;
              
              localStorage.setItem('cookierun_characters', JSON.stringify(characters));
              
              if (document.getElementById('charactersPage').classList.contains('active')) {
                filterCharacters(currentFilter);
                console.log('âœ… ìºë¦­í„° ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
                debugLog('âœ… ìºë¦­í„° ëª©ë¡ ìƒˆë¡œê³ ì¹¨', false);
              } else if (document.getElementById('allRelationsPage').classList.contains('active')) {
                renderRelationsPage(currentRelationsFilter);
                console.log('âœ… ê´€ê³„ë„ ìƒˆë¡œê³ ì¹¨');
                debugLog('âœ… ê´€ê³„ë„ ìƒˆë¡œê³ ì¹¨', false);
              }
            }
          }
        } catch (error) {
          console.error('âŒ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
          debugLog('âŒ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜: ' + error.message, true);
        }
      },
      (error) => {
        console.error('âŒ ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        debugLog('âŒ ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜: ' + error.message, true);
        setTimeout(setupRealtimeSync, 5000);
      }
    );
    
    window.firebaseUnsubscribe = unsubscribe;
    
    console.log('ğŸ”¥ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”!');
    debugLog('ğŸ”¥ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”!', false);
  } catch (error) {
    console.error('âŒ ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨:', error);
    debugLog('âŒ ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨: ' + error.message, true);
    setTimeout(setupRealtimeSync, 5000);
  }
}

let isEditMode = false;
let editingCharacterId = null;

function openEditCharacterModal(charId, game) {
  const char = characters.find(c => c.id === charId);
  if (!char) return;

  isEditMode = true;
  editingCharacterId = charId;
  currentModalGame = game;

  document.querySelectorAll('.btn-create').forEach(btn => btn.textContent = 'ìˆ˜ì • ì™„ë£Œ');
  document.querySelector('.modal-title').innerHTML = 'ğŸª ì •ë³´ ìˆ˜ì •';

  tempCharData = {
    ovenbreak: char.ovenbreak ? { ...char.ovenbreak } : null,
    kingdom: char.kingdom ? { ...char.kingdom } : null,
    tower: char.tower ? { ...char.tower } : null
  };

  document.getElementById('isOfficialModal').checked = char.isOfficial || false;

  if (char.ovenbreak) {
    document.getElementById('charNameModal').value = char.ovenbreak.name || char.name || '';
    document.getElementById('gradeModal').value = char.ovenbreak.grade || 'ì»¤ë¨¼';
    document.getElementById('petModal').value = char.ovenbreak.pet || '';
    document.getElementById('treasureModal').value = char.ovenbreak.treasure || '';
    document.getElementById('abilityModal').value = char.ovenbreak.ability || '';
    document.getElementById('tagsModal').value = char.ovenbreak.tags || '';
    document.getElementById('charColorModal').value = char.ovenbreak.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewModal');
    if (char.ovenbreak.photo) {
      preview.src = char.ovenbreak.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    } else {
      preview.style.display = 'none';
      preview.parentElement.querySelector('span').style.display = 'flex';
    }
  }

  if (char.kingdom) {
    document.getElementById('charNameKingdom').value = char.kingdom.name || char.name || '';
    document.getElementById('gradeKingdom').value = char.kingdom.grade || 'ì»¤ë¨¼';
    document.getElementById('typeKingdom').value = char.kingdom.type || 'ëŒê²©í˜•';
    document.getElementById('positionKingdom').value = char.kingdom.position || 'ì „ë°©';
    document.getElementById('elementKingdom').value = char.kingdom.element || 'ë¶ˆ';
    document.getElementById('skillNameKingdom').value = char.kingdom.skillName || '';
    document.getElementById('traitKingdom').value = char.kingdom.trait || '';
    document.getElementById('charColorKingdom').value = char.kingdom.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewKingdom');
    if (char.kingdom.photo) {
      preview.src = char.kingdom.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    } else {
      preview.style.display = 'none';
      preview.parentElement.querySelector('span').style.display = 'flex';
    }
  }

  if (char.tower) {
    document.getElementById('charNameTower').value = char.tower.name || char.name || '';
    document.getElementById('gradeTower').value = char.tower.grade || 'ì»¤ë¨¼';
    document.getElementById('roleTower').value = char.tower.role || 'ìŠ¤íŠ¸ë¼ì´ì»¤';
    document.getElementById('typeTower').value = char.tower.type || 'íƒ€ê²©í˜•';
    document.getElementById('elementTower').value = char.tower.element || 'ë¬¼';
    document.getElementById('skillNameTower').value = char.tower.skillName || '';
    document.getElementById('artifactTower').value = char.tower.artifact || '';
    document.getElementById('charColorTower').value = char.tower.color || '#fb923c';
    
    const preview = document.getElementById('createPhotoPreviewTower');
    if (char.tower.photo) {
      preview.src = char.tower.photo;
      preview.style.display = 'block';
      preview.parentElement.querySelector('span').style.display = 'none';
    } else {
      preview.style.display = 'none';
      preview.parentElement.querySelector('span').style.display = 'flex';
    }
  }

  switchModalTab(game);
  document.getElementById('modalUnified').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeUnifiedModal() {
  document.getElementById('modalUnified').classList.remove('active');
  document.body.style.overflow = '';
  isEditMode = false;
  editingCharacterId = null;
}

function updateAllRelationReferences(updatedChar) {
  let hasChanges = false;

  characters.forEach(char => {
    if (!char.relations) return;

    char.relations.forEach(rel => {
      if (rel.targetId === updatedChar.id) {
        rel.targetName = updatedChar.name;
        
        let targetData = updatedChar.ovenbreak || updatedChar.kingdom || updatedChar.tower;
        
        if (targetData) {
          rel.targetColor = targetData.color;
          rel.targetPhoto = targetData.photo;
        }
        hasChanges = true;
      }
    });
  });

  if (hasChanges) {
    console.log('ğŸ”„ ê´€ê³„ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
  }
}

async function addCharacterFromModal(game) {
  saveTempData(game);
  
  let charName = '';
  let gameData = {};
  
  if (game === 'ovenbreak') {
    charName = tempCharData.ovenbreak.name;
    gameData = tempCharData.ovenbreak;
  } else if (game === 'kingdom') {
    charName = tempCharData.kingdom.name;
    gameData = tempCharData.kingdom;
  } else if (game === 'tower') {
    charName = tempCharData.tower.name;
    gameData = tempCharData.tower;
  }
  
  if (!charName) {
    alert('Cookie name required!');
    return;
  }
  
  const isOfficial = document.getElementById('isOfficialModal').checked;
  
  if (isEditMode && editingCharacterId) {
    const char = characters.find(c => c.id === editingCharacterId);
    if (char) {
      char.name = charName;
      char.isOfficial = isOfficial;
      
      if (tempCharData.ovenbreak && tempCharData.ovenbreak.name) {
        char.ovenbreak = tempCharData.ovenbreak;
      }
      if (tempCharData.kingdom && tempCharData.kingdom.name) {
        char.kingdom = tempCharData.kingdom;
      }
      if (tempCharData.tower && tempCharData.tower.name) {
        char.tower = tempCharData.tower;
      }
      
      updateAllRelationReferences(char);
      
      await saveToLocalStorage();
      
      if (selectedChar && selectedChar.id === editingCharacterId) {
        selectCharacter(editingCharacterId, game);
      }
      
      filterCharacters(currentFilter);
      closeUnifiedModal();
      
      alert('ìˆ˜ì • ì™„ë£Œ!');
      return;
    }
  }
  
  const newChar = {
    id: Date.now(),
    name: charName,
    isOfficial: isOfficial,
    relations: []
  };
  
  if (tempCharData.ovenbreak && tempCharData.ovenbreak.name) {
    newChar.ovenbreak = tempCharData.ovenbreak;
  }
  if (tempCharData.kingdom && tempCharData.kingdom.name) {
    newChar.kingdom = tempCharData.kingdom;
  }
  if (tempCharData.tower && tempCharData.tower.name) {
    newChar.tower = tempCharData.tower;
  }
  
  characters.push(newChar);
  
  await saveToLocalStorage();
  
  filterCharacters(currentFilter);
  closeUnifiedModal();
  
  clearForm('ovenbreak');
  clearForm('kingdom');
  clearForm('tower');
  
  tempCharData = {
    ovenbreak: null,
    kingdom: null,
    tower: null
  };
  
  alert('Added!');
}

let currentOriginFilter = 'all'; // 'all', 'oc', 'official'

function setOriginFilter(filter) {
  currentOriginFilter = filter;
  
  document.querySelectorAll('.origin-btn').forEach(btn => btn.classList.remove('active'));
  const buttons = document.querySelectorAll('.origin-btn');
  if(filter === 'all') buttons[0].classList.add('active');
  if(filter === 'oc') buttons[1].classList.add('active');
  if(filter === 'official') buttons[2].classList.add('active');
  
  filterCharacters(currentFilter);
}

</script>
</body>
</html>